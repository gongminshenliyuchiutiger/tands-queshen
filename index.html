<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>時空學園命題設計引導系統</title>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- Google Fonts for Tech Minimalist style -->
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Exo+2:wght@300;400;700&display=swap" rel="stylesheet">
    <style>
        /* Tech Minimalist Theme - Optimized for Clean Lines and Subtle Accents */
        :root {
            /* Base Colors - Clean & Professional */
            --bg-light: rgb(245, 250, 255); /* 輕盈的背景色 */
            --container-bg: rgba(255, 255, 255, 0.95); /* 近乎不透明的白色容器 */
            --text-dark: rgb(25, 25, 25); /* 主要深色文字 */
            --text-medium: rgb(75, 75, 75); /* 中度深色文字 */
            --border-light: rgb(200, 215, 230); /* 淺色邊框 */
            --text-black: rgb(0, 0, 0); /* 純黑色文字 */

            /* Primary UI Accent Colors (avoiding answer colors) */
            --primary-ui-blue: rgb(0, 120, 200); /* 主介面藍色 - 更沉穩 */
            --ui-success-green: rgb(50, 180, 50); /* UI成功綠 */
            --ui-error-red: rgb(220, 70, 70); /* UI錯誤紅 */
            --accent-teal: rgb(0, 170, 170); /* 新增的科技感點綴色 */
            --accent-gray: rgb(150, 160, 170); /* 中性灰色 */
            --incorrect-card-gray: rgb(200, 200, 200); /* 錯誤知識卡灰色 */

            /* Specific Answer Colors (Red, Green, Blue, Purple) - Keep for meaning */
            --answer-red: rgb(200, 40, 40);
            --answer-green: rgb(40, 160, 40);
            --answer-blue: rgb(40, 40, 200);
            --answer-purple: rgb(120, 40, 200);

            /* Shadow Effects - Subtle, no glows */
            --shadow-container: 0 4px 15px rgba(0, 0, 0, 0.08), 0 0 5px rgba(var(--primary-ui-blue-rgb), 0.1);
            --shadow-button: 0 2px 5px rgba(0, 0, 0, 0.15);
            --shadow-button-hover: 0 4px 10px rgba(0, 0, 0, 0.25);
            --shadow-card: 0 2px 8px rgba(0, 0, 0, 0.05);

            /* Helper for RGBA conversion in CSS variables */
            --primary-ui-blue-rgb: 0, 120, 200;
            --ui-error-red-rgb: 220, 70, 70;
            --ui-success-green-rgb: 50, 180, 50;
            --accent-teal-rgb: 0, 170, 170;
            --incorrect-card-gray-rgb: 200, 200, 200;

            --container-bg-rgb: 255, 255, 255;
            --text-dark-rgb: 25, 25, 25;
            --border-light-rgb: 200, 215, 230;

            /* Starry background colors for CSS pseudo-elements (now used by tsparticles) */
            --star-color-1: rgba(255, 220, 0, 0.7); /* Yellow */
            --star-color-2: rgba(0, 160, 255, 0.7); /* Blue */
            --star-color-3: rgba(100, 255, 100, 0.7); /* Green */
            --star-color-4: rgba(255, 100, 100, 0.7); /* Red */
            --star-color-5: rgba(150, 60, 255, 0.7); /* Purple */
            --star-color-6: rgba(255, 255, 255, 0.7); /* White */
        }

        html, body {
            height: 100%; /* Ensure full height for fixed background */
        }

        body {
            font-family: 'Exo 2', sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 20px;
            /* Make body background transparent to show tsparticles */
            background-color: transparent;
            background-image: none;
            color: var(--text-dark);
            padding-bottom: 80px;
            overflow-x: hidden;
            position: relative;
            /* z-index removed from body, rely on container's z-index for content */
        }

        /* tsparticles container itself needs to cover the viewport and be behind content */
        #tsparticles {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -2; /* Behind all body content and footer */
            pointer-events: none; /* Make sure it doesn't block clicks */
        }

        .container {
            max-width: 1000px;
            margin: 20px auto;
            background: var(--container-bg);
            padding: 30px;
            border-radius: 10px;
            box-shadow: var(--shadow-container);
            border: 1px solid var(--border-light);
            position: relative;
            z-index: 2; /* Ensure container is above particles */
        }

        h1, h2, h3, h4, h5 {
            font-family: 'Orbitron', sans-serif;
            border-bottom: 1px solid var(--border-light);
            padding-bottom: 10px;
            margin-top: 30px;
            margin-bottom: 20px;
            color: var(--text-black);
            text-shadow: none;
        }

        h1 {
            text-align: center;
            font-size: 2.2em;
            color: var(--primary-ui-blue);
            border-bottom-color: var(--primary-ui-blue);
            display: flex; /* For aligning text and icon */
            align-items: center; /* Vertically center items */
            justify-content: center; /* Horizontally center content */
        }

        h1 i.fa-rocket {
            margin-right: 10px; /* Space between rocket icon and text */
        }

        #help-link-in-h1 {
            color: var(--accent-teal); /* Use accent color for consistency */
            font-size: 0.8em; /* Adjust size to fit H1 better */
            text-decoration: none;
            transition: color 0.2s ease, transform 0.2s ease;
            margin-left: 15px; /* Space from title */
        }
        #help-link-in-h1:hover {
            color: rgb(0, 140, 140); /* Darker teal on hover */
            transform: scale(1.1);
        }

        h2 {
            font-size: 1.6em;
            color: var(--accent-teal);
            border-bottom-color: var(--accent-teal);
        }

        h3 {
            font-size: 1.3em;
            color: var(--text-dark);
            border-bottom-color: var(--border-light);
        }
        h4 {
            font-size: 1.1em;
            color: var(--text-dark);
            border-bottom-color: var(--border-light);
        }
        h5 {
            font-size: 1em;
            color: var(--text-medium);
            border-bottom: none;
        }

        p {
            margin-bottom: 15px;
            color: var(--text-dark);
        }

        .form-group {
            margin-bottom: 20px;
            position: relative;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: var(--text-dark);
        }
        /* Spacing for icons within labels */
        label .fas {
            margin-right: 8px;
        }

        .required-star {
            color: var(--ui-error-red);
            margin-left: 3px;
        }

        input[type="text"],
        input[type="url"],
        input[type="file"],
        input[type="password"],
        textarea,
        select {
            width: calc(100% - 22px);
            padding: 10px;
            border: 1px solid var(--border-light);
            border-radius: 6px;
            box-sizing: border-box;
            font-size: 0.95em;
            background-color: rgb(250, 252, 255);
            color: var(--text-dark);
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
            box-shadow: inset 0 1px 2px rgba(0,0,0,0.03);
        }
        input[type="file"] {
            padding: 6px 10px;
            background-color: var(--bg-light);
        }
        input[type="checkbox"] {
            accent-color: var(--primary-ui-blue);
        }
        input[type="checkbox"] + label {
            color: var(--text-dark);
        }

        input[type="text"]:focus,
        input[type="url"]:focus,
        input[type="password"]:focus,
        textarea:focus,
        select:focus {
            border-color: var(--primary-ui-blue);
            box-shadow: 0 0 0 2px rgba(var(--primary-ui-blue-rgb), 0.2);
            outline: none;
            background-color: white;
        }
        
        #answersAndHintsForms input[type="text"][readonly] {
            font-weight: bold;
            background-color: rgb(240, 240, 240);
            border-color: var(--border-light);
        }
        #answersAndHintsForms input[type="text"][readonly].color-0 { color: var(--answer-red); }
        #answersAndHintsForms input[type="text"][readonly].color-1 { color: var(--answer-green); }
        #answersAndHintsForms input[type="text"][readonly].color-2 { color: var(--answer-blue); }
        #answersAndHintsForms input[type="text"][readonly].color-3 { color: var(--answer-purple); }

        #knowledgeCardSets input[type="text"].color-0 { color: var(--answer-red); }
        #knowledgeCardSets input[type="text"].color-1 { color: var(--answer-green); }
        #knowledgeCardSets input[type="text"][readonly].color-2 { color: var(--answer-blue); }
        #knowledgeCardSets input[type="text"][readonly].color-3 { color: var(--answer-purple); }


        .select-group {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .select-group select {
            width: auto;
            flex-grow: 1;
            min-width: 120px;
        }

        textarea {
            min-height: 80px;
            resize: vertical;
        }

        .word-count {
            font-size: 0.8em;
            color: var(--text-medium);
            text-align: right;
            margin-top: 5px;
        }

        .button-group {
            display: flex;
            justify-content: flex-end;
            margin-top: 25px;
            gap: 10px;
            flex-wrap: wrap;
        }

        button {
            background-color: var(--primary-ui-blue);
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1em;
            font-weight: bold;
            transition: background-color 0.2s ease, transform 0.1s ease, box-shadow 0.2s ease;
            box-shadow: var(--shadow-button);
            flex-shrink: 0;
        }
        button i {
            margin-right: 5px;
        }

        button:hover {
            background-color: rgb(0, 100, 180);
            transform: translateY(-1px);
            box-shadow: var(--shadow-button-hover);
        }

        button:active {
            transform: translateY(0);
            box-shadow: var(--shadow-button);
        }

        button.secondary {
            background-color: var(--border-light);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            color: var(--text-dark);
        }

        button.secondary:hover {
            background-color: rgb(180, 195, 210);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.15);
        }

        button.danger {
            background-color: var(--ui-error-red);
        }

        button.danger:hover {
            background-color: rgb(190, 50, 50);
        }

        button.back {
            background-color: var(--accent-teal);
            color: white;
        }
        button.back:hover {
            background-color: rgb(0, 140, 140);
        }

        button:disabled {
            background-color: rgb(200, 200, 200);
            cursor: not-allowed;
            box-shadow: none;
            color: rgb(150, 150, 150);
        }
        /* AI Button general style */
        .ai-button {
            background-color: var(--primary-ui-blue);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            color: white;
            padding: 8px 15px;
            font-size: 0.9em;
            border-radius: 5px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        .ai-button:hover:not(:disabled) {
            background-color: rgb(0, 100, 180);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.15);
            transform: translateY(-1px);
        }
        .ai-button.inline-small {
            background: none;
            border: none;
            box-shadow: none;
            padding: 0;
            font-size: 1.1em;
            margin-left: 8px;
            width: auto;
            min-width: 0;
            color: var(--primary-ui-blue);
        }
        .ai-button.inline-small:hover:not(:disabled) {
            background: none;
            box-shadow: none;
            transform: translateY(-1px) scale(1.1);
            color: rgb(0, 100, 180);
        }
        .ai-button.inline-small:disabled {
            background: none;
            box-shadow: none;
            color: var(--accent-gray);
        }
        .ai-button.inline-small i {
            margin-right: 0;
        }
        .ai-button.inline-small .loading-spinner {
            width: 0.8em;
            height: 0.8em;
            margin-right: 0;
            border-top: 2px solid var(--primary-ui-blue);
        }


        /* 表格樣式 */
        .table-wrapper {
            overflow-x: auto;
            margin-top: 15px;
            margin-bottom: 15px;
            border-radius: 8px;
            border: 1px solid var(--border-light);
            background-color: var(--container-bg);
            box-shadow: var(--shadow-card);
        }
        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 600px;
            border: none;
        }

        th, td {
            border: 1px solid var(--border-light);
            padding: 12px;
            text-align: left;
            color: var(--text-dark);
            font-size: 0.9em;
        }

        th {
            background-color: rgb(230, 240, 248);
            font-weight: bold;
            color: var(--primary-ui-blue);
            text-shadow: none;
        }

        tr:nth-child(even) {
            background-color: rgba(var(--border-light-rgb), 0.1);
        }

        /* Part 2 關鍵詞定義表格的顏色循環 */
        #keyphraseCategoryTable tbody tr input { 
            border-left: 5px solid; 
            padding-left: 5px; 
        } 


        /* 預覽區塊 */
        .preview-box {
            background-color: rgb(250, 252, 255);
            border: 1px dashed var(--primary-ui-blue);
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            white-space: pre-wrap;
            color: var(--text-dark);
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.05);
        }

        .highlight {
            padding: 1px 4px;
            border-radius: 4px;
            font-weight: bold;
            background-color: rgba(var(--primary-ui-blue-rgb), 0.1);
            text-shadow: none;
        }
        .highlight.color-0 { color: var(--answer-red); }
        .highlight.color-1 { color: var(--answer-green); }
        .highlight.color-2 { color: var(--answer-blue); }
        .highlight.color-3 { color: var(--answer-purple); }


        /* 知識卡樣式 */
        .knowledge-card {
            border: 1px solid var(--border-light);
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 8px;
            background-color: var(--container-bg);
            box-shadow: var(--shadow-card);
            position: relative;
        }

        .knowledge-card.correct {
            border-color: var(--ui-success-green);
            background-color: rgba(var(--ui-success-green-rgb), 0.05);
            box-shadow: 0 0 8px rgba(var(--ui-success-green-rgb), 0.1), var(--shadow-card);
        }

        .knowledge-card.incorrect {
            border-color: var(--incorrect-card-gray);
            background-color: rgba(var(--incorrect-card-gray-rgb), 0.08);
            box-shadow: 0 0 6px rgba(var(--incorrect-card-gray-rgb), 0.1), var(--shadow-card);
        }

        /* Part 3 關鍵詞標題顏色 */
        #answersAndHintsForms .knowledge-card h3 {
            font-family: 'Orbitron', sans-serif;
            border-bottom: none;
            text-shadow: none;
        }
        #answersAndHintsForms .knowledge-card h3.color-0 { color: var(--answer-red); }
        #answersAndHintsForms .knowledge-card h3.color-1 { color: var(--answer-green); }
        #answersAndHintsForms .knowledge-card h3.color-2 { color: var(--answer-blue); }
        #answersAndHintsForms .knowledge-card h3.color-3 { color: var(--answer-purple); }


        /* Part 4 知識卡組標題顏色 */
        #knowledgeCardSets .card-set-for-keyphrase h3 {
            font-family: 'Orbitron', sans-serif;
            border-bottom: 1px solid var(--accent-teal);
            text-shadow: none;
            margin-bottom: 25px;
            color: var(--accent-teal);
        }
        #knowledgeCardSets .card-set-for-keyphrase h3.color-0 { color: var(--answer-red); border-bottom-color: var(--answer-red); }
        #knowledgeCardSets .card-set-for-keyphrase h3.color-1 { color: var(--answer-green); border-bottom-color: var(--answer-green); }
        #knowledgeCardSets .card-set-for-keyphrase h3.color-2 { color: var(--answer-blue); border-bottom-color: var(--answer-blue); }
        #knowledgeCardSets .card-set-for-keyphrase h3.color-3 { color: var(--answer-purple); border-bottom-color: var(--answer-purple); }


        .knowledge-card h4 {
            color: var(--text-dark);
            margin-top: 0;
            border-bottom: 1px solid var(--border-light);
            padding-bottom: 8px;
        }
        .knowledge-card.incorrect h4 {
            color: var(--text-dark);
            border-bottom-color: var(--incorrect-card-gray);
        }
        .knowledge-card h5 {
            color: var(--text-dark);
            margin-top: 0;
            border-bottom: 1px dashed var(--border-light);
            padding-bottom: 5px;
            font-size: 0.95em;
        }

        .image-preview {
            max-width: 120px;
            max-height: 120px;
            margin-top: 10px;
            border: 1px solid var(--primary-ui-blue);
            display: block;
            object-fit: contain;
            background-color: rgba(255,255,255,0.5);
            border-radius: 5px;
            box-shadow: 0 0 5px rgba(var(--primary-ui-blue-rgb), 0.1);
        }
        .image-preview.loading {
            animation: pulse-border 1.5s infinite ease-in-out;
            background-color: rgba(var(--primary-ui-blue-rgb), 0.05);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--primary-ui-blue);
            font-size: 1.5em;
        }
        @keyframes pulse-border {
            0% { border-color: var(--primary-ui-blue); box-shadow: 0 0 5px rgba(var(--primary-ui-blue-rgb), 0.1); }
            50% { border-color: rgba(var(--primary-ui-blue-rgb), 0.5); box-shadow: 0 0 10px rgba(var(--primary-ui-blue-rgb), 0.2); }
            100% { border-color: var(--primary-ui-blue); box-shadow: 0 0 5px rgba(var(--primary-ui-blue-rgb), 0.1); }
        }


        /* 總結區塊 */
        .summary-section {
            background-color: rgba(var(--primary-ui-blue-rgb), 0.05);
            border: 1px solid var(--primary-ui-blue);
            padding: 20px;
            border-radius: 8px;
            margin-top: 25px;
            box-shadow: 0 0 8px rgba(var(--primary-ui-blue-rgb), 0.1), inset 0 1px 3px rgba(0,0,0,0.05);
        }

        .summary-section h3 {
            color: var(--primary-ui-blue);
            border-bottom-color: var(--primary-ui-blue);
        }

        .summary-content pre {
            background-color: rgb(248, 252, 255);
            border: 1px solid var(--border-light);
            padding: 15px;
            border-radius: 6px;
            max-height: 350px;
            overflow-y: auto;
            color: var(--text-dark);
            font-size: 0.9em;
        }

        /* 版權和吉祥物 */
        .footer {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 40px;
            background-color: rgb(220, 230, 240);
            color: var(--text-medium);
            padding: 5px 20px;
            text-align: center;
            font-size: 0.85em;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 -1px 8px rgba(0,0,0,0.08);
            z-index: 1000;
        }
        .footer span {
            color: var(--text-medium);
        }


        .mascot-wrapper {
            position: fixed;
            left: 20px;
            bottom: 20px;
            z-index: 1001;
            cursor: pointer;
            transition: transform 0.2s ease, filter 0.3s ease;
            filter: drop-shadow(0 2px 5px rgba(0,0,0,0.1));
            transform-origin: bottom center;
        }
        @keyframes mascot-shake {
            0%, 100% { transform: translateY(0) rotate(0deg); }
            25% { transform: translateY(-5px) rotate(2deg); }
            75% { transform: translateY(-5px) rotate(-2deg); }
        }
        .mascot-wrapper:hover {
            animation: mascot-shake 0.5s ease-in-out infinite;
            filter: drop-shadow(0 0 10px rgba(0, 120, 200, 0.6)) drop-shadow(0 0 20px rgba(0, 120, 200, 0.3));
        }

        .mascot-image {
            height: calc(50px * 2.5);
            width: auto;
            object-fit: contain;
            display: block;
        }
        
        .footer .left-content, .footer .right-content {
            flex-basis: 150px;
            flex-grow: 1;
            text-align: left;
        }
        .footer .right-content {
            text-align: right;
        }
        .footer .center-content {
            flex-grow: 1;
            text-align: center;
        }

        /* Custom input group for "Other" subjects */
        .custom-input-group {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 5px;
        }
        .custom-input-group input[type="text"] {
            width: 100%;
        }

        /* API key section */
        .api-key-compact-panel {
            background-color: rgba(var(--primary-ui-blue-rgb), 0.05);
            border: 1px solid var(--primary-ui-blue);
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 25px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }
        .api-key-compact-label {
            display: flex;
            align-items: center;
            font-weight: bold;
            color: var(--text-dark);
            margin-bottom: 10px;
        }
        .api-key-compact-panel .fa-key {
            margin-right: 8px;
            color: var(--primary-ui-blue);
        }
        .api-key-compact-panel .api-tutorial-link {
            font-size: 0.85em;
            margin-left: auto;
            white-space: nowrap;
            color: var(--primary-ui-blue);
            text-decoration: none;
        }
        .api-key-compact-panel .api-tutorial-link:hover {
            text-decoration: underline;
        }
        .api-key-compact-panel input[type="password"] {
            width: calc(100% - 2px);
            margin-top: 0;
            margin-bottom: 5px;
        }
        .api-key-hint-text {
            display: block;
            font-size: 0.8em;
            color: var(--text-medium);
            margin-top: 5px;
        }

        /* Modal styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            animation: fadeIn 0.3s;
        }
        .modal-content {
            background: var(--container-bg);
            padding: 30px;
            border-radius: 10px;
            max-width: 600px;
            width: 90%;
            position: relative;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
            max-height: 85vh;
            overflow-y: auto;
            border: 1px solid var(--primary-ui-blue);
        }
        .modal-content h3 {
            color: var(--primary-ui-blue);
            margin-bottom: 20px;
            font-size: 1.5em;
            border-bottom: 1px solid var(--border-light);
            padding-bottom: 10px;
            padding-right: 30px;
        }
        .modal-content p, .modal-content li {
            color: var(--text-dark);
            margin-bottom: 10px;
        }
        .modal-content ol {
            padding-left: 20px;
        }
        .modal-content a {
            color: var(--primary-ui-blue);
            text-decoration: none;
        }
        .modal-content a:hover {
            text-decoration: underline;
        }

        /* Modal Close Button - Global styles for both modals' 'X' buttons */
        .modal-close {
            background-color: transparent; /* Explicitly transparent */
            border: none; /* No border */
            box-shadow: none; /* No shadow */
            outline: none; /* No outline */
            cursor: pointer;
            width: 30px; /* Fixed width for better click area */
            height: 30px; /* Fixed height for better click area */
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8em; /* Consistent font size */
            color: var(--primary-ui-blue); /* Default blue color */
            transition: color 0.2s ease, transform 0.2s ease; /* Smooth transition */
            padding: 0; /* Remove default button padding */
            line-height: 1; /* Center the 'X' icon better */
            /* Ensure no browser-specific focus outline for Firefox */
            -moz-focus-inner: { border: 0; }
        }
        /* Hover, Focus, Active states for modal-close */
        .modal-close:hover,
        .modal-close:focus,
        .modal-close:active {
            background-color: transparent; /* Ensure no background on interaction */
            border: none; /* Ensure no border on interaction */
            box-shadow: none; /* Ensure no shadow on interaction */
            outline: none; /* Ensure no outline on interaction */
        }
        /* Only apply transform and color change on hover */
        .modal-close:hover {
            transform: scale(1.1); /* Enlarge on hover */
            color: var(--ui-error-red); /* Red on hover */
        }
        /* For focus/active states without hover, keep default blue and no scale */
        .modal-close:focus,
        .modal-close:active {
            transform: none;
            color: var(--primary-ui-blue);
        }


        /* Specific positioning for API Key Tutorial Modal's close button */
        #apiKeyTutorialModal .modal-close {
            position: absolute; /* Absolute positioning within its parent modal-content */
            top: 15px;
            right: 15px;
        }

        /* Specific positioning for Help Modal's close button */
        #help-modal .modal-close {
            position: static; /* Let it flow within the flex header */
            margin-left: auto; /* Push to the right within the flex container */
        }


        /* Loading spinner for AI buttons */
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .loading-spinner {
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top: 2px solid white;
            border-radius: 50%;
            width: 1.1em;
            height: 1.1em;
            animation: spin 0.8s linear infinite;
            display: inline-block;
            margin-right: 5px;
            vertical-align: middle;
        }
        .loading-spinner.inline-small {
            width: 0.8em;
            height: 0.8em;
            margin-right: 0;
            border-top: 2px solid var(--primary-ui-blue);
        }

        /* Flex container for label + AI button */
        .label-with-ai-button {
            display: flex;
            align-items: center;
        }
        .label-with-ai-button label {
            margin-bottom: 0;
            flex-grow: 0;
            white-space: nowrap;
            margin-right: 5px;
        }

        /* Toast Message Styles */
        #toast-container {
            position: fixed;
            bottom: 60px;
            right: 20px;
            z-index: 2500;
            display: flex;
            flex-direction: column;
            gap: 10px;
            pointer-events: none;
        }
        .toast {
            background-color: rgba(var(--text-dark-rgb), 0.9);
            color: white;
            padding: 10px 18px;
            border-radius: 6px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.15);
            font-size: 0.9em;
            opacity: 0;
            transform: translateY(15px);
            transition: opacity 0.3s ease-out, transform 0.3s ease-out;
            min-width: 200px;
            max-width: 300px;
            display: flex;
            align-items: center;
            gap: 8px;
            pointer-events: auto;
        }
        .toast.show {
            opacity: 1;
            transform: translateY(0);
        }
        .toast.info { background-color: rgba(var(--primary-ui-blue-rgb), 0.9); }
        .toast.success { background-color: rgba(var(--ui-success-green-rgb), 0.9); }
        .toast.error { background-color: rgba(var(--ui-error-red-rgb), 0.9); }
        .toast i { font-size: 1.1em; }

        /* AI Overlay for sections */
        .ai-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.75);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            z-index: 10;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
            color: var(--primary-ui-blue);
            font-size: 1.1em;
            font-weight: bold;
            text-align: center;
            padding: 10px;
            box-sizing: border-box;
        }
        .ai-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        .ai-overlay .loading-spinner {
            border-top-color: var(--primary-ui-blue);
            margin-bottom: 8px;
            width: 1.8em;
            height: 1.8em;
        }

        /* Global AI Progress indicator (for generateAllHintsAI) */
        #global-ai-progress {
            background-color: rgba(var(--primary-ui-blue-rgb), 0.9);
            color: white;
            padding: 10px 20px;
            border-radius: 6px;
            margin-bottom: 20px;
            text-align: center;
            font-weight: bold;
            display: none;
            align-items: center;
            justify-content: center;
            gap: 10px;
            box-shadow: var(--shadow-button);
        }
        #global-ai-progress.active {
            display: flex;
        }

        /* Part 4 Specific Layout Improvements */
        .incorrect-cards-group {
            margin-top: 30px;
        }
        .incorrect-cards-group > p {
            margin-bottom: 20px;
            font-size: 0.95em;
            color: var(--text-medium);
        }
        .incorrect-card-item {
            border: 1px solid var(--border-light);
            background-color: rgb(250, 252, 255);
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 15px;
            box-shadow: var(--shadow-card);
            position: relative;
        }
        .incorrect-card-item h5 {
            margin-bottom: 10px;
            color: var(--text-dark);
            border-bottom: 1px dashed var(--border-light);
            padding-bottom: 5px;
        }
        .incorrect-card-item .form-group {
            margin-bottom: 15px;
        }
        .incorrect-card-item details {
            margin-top: 15px;
            padding-top: 10px;
            border-top: 1px dashed var(--border-light);
        }
        .incorrect-card-item details summary {
            font-weight: bold;
            color: var(--primary-ui-blue);
            cursor: pointer;
            padding: 5px 0;
            list-style: none;
            display: flex;
            align-items: center;
        }
        .incorrect-card-item details summary::before {
            content: "\f054"; /* Font Awesome solid right arrow unicode */
            font-family: "Font Awesome 6 Free";
            font-weight: 900;
            margin-right: 8px;
            transition: transform 0.2s ease;
            display: inline-block;
            color: var(--primary-ui-blue);
        }
        .incorrect-card-item details[open] summary::before {
            transform: rotate(90deg);
        }
        .incorrect-card-item details summary:hover {
            color: rgb(0, 100, 180);
        }
        .incorrect-card-item details p {
            font-size: 0.85em;
            color: var(--text-medium);
            margin-bottom: 10px;
        }
        .incorrect-card-item details input[type="file"],
        .incorrect-card-item details input[type="url"] {
            margin-top: 5px;
        }

        /* JSON Import/Export Buttons Layout */
        .json-import-export-group {
            margin-top: 20px;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: center;
        }
        .json-import-export-group label {
            flex-basis: 100%;
            margin-bottom: 5px;
        }
        .json-import-export-group input[type="file"] {
            flex-grow: 1;
            min-width: 150px;
            margin-bottom: 0;
        }
        .json-import-export-group button {
            flex-grow: 1;
            min-width: 100px;
            margin-bottom: 0;
        }
        .form-group > .json-import-export-group {
            margin-bottom: 0;
        }

        /* Help Modal (Draggable/Resizable) */
        #help-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--container-bg);
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
            border: 1px solid var(--primary-ui-blue);
            z-index: 2100;
            min-width: 300px;
            min-height: 200px;
            width: 500px;
            height: 400px;
            resize: both;
            overflow: auto;
            display: none;
            will-change: top, left, width, height;
        }
        #help-modal.resizing {
            resize: none;
        }
        #help-modal .modal-header {
            cursor: grab;
            padding-bottom: 10px;
            margin-bottom: 15px;
            border-bottom: 1px solid var(--border-light);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        #help-modal .modal-header h3 {
            margin: 0;
            padding: 0;
            border: none;
            font-size: 1.3em;
            color: var(--primary-ui-blue);
        }

        #help-modal .modal-content-body {
            font-size: 0.95em;
            color: var(--text-dark);
            line-height: 1.6;
        }
        #help-modal .modal-content-body h4 {
            font-size: 1.1em;
            margin-top: 15px;
            margin-bottom: 10px;
            border-bottom: 1px dashed var(--border-light);
            padding-bottom: 5px;
        }
        #help-modal .modal-content-body ol,
        #help-modal .modal-content-body ul {
            padding-left: 20px;
            margin-bottom: 10px;
        }
        #help-modal .modal-content-body li {
            margin-bottom: 5px;
        }

        /* Resizer handle for help modal */
        #help-modal .resizer {
            width: 10px;
            height: 10px;
            background: transparent;
            position: absolute;
            right: 0;
            bottom: 0;
            cursor: se-resize;
            z-index: 10;
        }


        /* Responsive Adjustments */
        @media screen and (max-width: 768px) {
            body {
                padding: 10px;
                padding-bottom: 60px;
            }
            .container {
                margin: 10px auto;
                padding: 15px;
            }
            h1 {
                font-size: 1.8em;
                flex-direction: column; /* Stack H1 elements vertically on small screens */
                gap: 5px;
            }
            h1 i.fa-rocket {
                margin-right: 0;
            }
            #help-link-in-h1 {
                margin-left: 0; /* No margin on smaller screens if stacked */
                font-size: 1em; /* Adjust size for mobile */
            }
            h2 {
                font-size: 1.4em;
            }
            .button-group {
                flex-direction: column;
                gap: 8px;
            }
            button {
                width: 100%;
                padding: 10px 15px;
                font-size: 0.95em;
            }
            .select-group {
                flex-direction: column;
                gap: 10px;
                align-items: stretch;
            }
            .select-group select {
                width: 100%;
            }

            .footer {
                height: auto;
                padding: 8px 10px;
                flex-direction: column;
                font-size: 0.8em;
            }
            .footer .left-content, .footer .right-content {
                flex-basis: auto;
                width: 100%;
                text-align: center;
            }
            .footer .center-content {
                order: 1;
                margin-bottom: 5px;
            }
            .footer .left-content { order: 2; }
            .footer .right-content { order: 3; }

            .mascot-wrapper {
                left: 10px;
                bottom: 10px;
                height: 70px;
            }
            .mascot-image {
                height: 100%;
            }
            #toast-container {
                bottom: 20px;
                right: 10px;
                left: 10px;
                align-items: center;
            }
            .toast {
                width: calc(100% - 20px);
                max-width: unset;
            }
            .ai-overlay {
                font-size: 1em;
            }
            .ai-overlay .loading-spinner {
                width: 1.5em;
                height: 1.5em;
            }

            .modal-content {
                width: calc(100% - 40px);
            }
            .modal-close {
                top: 10px;
                right: 10px;
            }
            .modal-content h3 {
                padding-right: 20px;
            }
            .json-import-export-group {
                flex-direction: column;
                gap: 8px;
            }
            .json-import-export-group input[type="file"],
            .json-import-export-group button {
                width: 100%;
                min-width: unset;
            }

            /* Help button removed, no need for #help-button responsive adjustments */
            #help-modal {
                width: 90vw;
                height: 80vh;
                min-width: unset;
                min-height: unset;
            }
        }

        @media screen and (max-width: 480px) {
            .mascot-wrapper {
                height: 50px;
            }
            h1 { font-size: 1.6em; }
            h2 { font-size: 1.2em; }
            .modal-content {
                padding: 15px;
            }
            .modal-content h3 {
                font-size: 1.3em;
            }
            .incorrect-card-item details summary {
                font-size: 0.9em;
            }
        }
    </style>
</head>
<body>
    <!-- Particles.js Container -->
    <div id="tsparticles"></div>

    <div class="container">
        <h1>
            <i class="fas fa-rocket"></i>
            時空學園命題設計引導系統
            <a href="#" id="help-link-in-h1" title="使用說明">
                <i class="fas fa-circle-info"></i>
            </a>
        </h1>
        <p>歡迎來到時空學園命題設計引導系統！本系統將帶您一步步了解如何為「時空學園」遊戲設計引人入勝且具備教育意義的題目。我們的核心策略是「<strong>多層次逐步揭示資訊</strong>」，透過循序漸進的提示，引導學生思考、學習，並最終掌握知識。</p>

        <!-- API Key Setup Section -->
        <div class="api-key-compact-panel">
            <label for="user-api-key" class="api-key-compact-label">
                <i class="fas fa-key"></i> Google Gemini API 金鑰 (必填)<span class="required-star">*</span>
                <a href="#" class="api-tutorial-link" id="show-api-tutorial">如何取得？</a>
            </label>
            <input type="password" id="user-api-key" placeholder="請貼上您的 API 金鑰" autocomplete="off" required>
            <small class="api-key-hint-text">此金鑰僅儲存在您的瀏覽器中。錯誤的金鑰將導致 AI 功能無法使用。</small>
        </div>


        <section id="part1">
            <h2><i class="fas fa-cube"></i> Part 1: 基礎任務設定</h2>
            <p>在開始設計具體的題目內容前，請先填寫本次命題的整體資訊。</p>

            <div class="form-group">
                <label for="missionTitle"><i class="fas fa-layer-group"></i> 1. 任務名稱 (Mission Title)<span class="required-star">*</span></label>
                <input type="text" id="missionTitle" value="" required>
            </div>

            <div class="form-group">
                <label for="mainSubject"><i class="fas fa-book-reader"></i> 2. 主要學科 (Main Subject)<span class="required-star">*</span></label>
                <select id="mainSubject" required>
                    <option value="" selected>請選擇</option>
                    <option value="國語">國語</option>
                    <option value="英語">英語</option>
                    <option value="數學">數學</option>
                    <option value="自然">自然</option>
                    <option value="社會">社會</option>
                    <option value="國文">國文</option>
                    <option value="英文">英文</option>
                    <option value="理化">理化</option>
                    <option value="生物">生物</option>
                    <option value="地科">地科</option>
                    <option value="歷史">歷史</option>
                    <option value="地理">地理</option>
                    <option value="公民">公民</option>
                    <option value="其他">其他 (請輸入)</option>
                </select>
                <div id="customMainSubjectInputGroup" class="custom-input-group" style="display: none;">
                    <input type="text" id="customMainSubject" placeholder="請輸入主學科名稱*" required>
                </div>
            </div>

            <div class="form-group">
                <label><i class="fas fa-tags"></i> 3. 其他學科 (Other Subjects)</label>
                <div id="otherSubjectsCheckboxes">
                    <!-- 動態生成其他學科選項 -->
                </div>
                <div id="customOtherSubjectInputGroup" class="custom-input-group" style="display: none;">
                    <input type="text" id="customOtherSubject" placeholder="請輸入其他學科名稱 (多個請用逗號分隔)">
                </div>
            </div>

            <div class="form-group">
                <label for="curriculumGuidelines"><i class="fas fa-scroll"></i> 4. 課綱 (Curriculum Guidelines)</label>
                <input type="text" id="curriculumGuidelines" value="">
            </div>

            <div class="form-group">
                <label><i class="fas fa-chart-line"></i> 5. 等級 (Difficulty Level)<span class="required-star">*</span></label>
                <div class="select-group">
                    <select id="gradeLevel" required>
                        <option value="" selected>選擇年級</option>
                        <script>
                            for(let i=1; i<=12; i++) {
                                document.write(`<option value="${i}">${i}</option>`);
                            }
                        </script>
                    </select>
                    <select id="semesterLevel" required>
                        <option value="" selected>選擇學期/階段</option>
                        <option value="A">A (上學期前半)</option>
                        <option value="B">B (上學期後半)</option>
                        <option value="C">C (下學期前半)</option>
                        <option value="D">D (下學期後半)</option>
                    </select>
                </div>
                <small>(數字為12年國教個個年段，A、B與C、D代表上學期前半、後半及下學期前半、後半)</small>
            </div>

            <div class="form-group">
                <label for="location"><i class="fas fa-map-marker-alt"></i> 6. 地點 (Location)</label>
                <input type="text" id="location" value="">
            </div>

            <div class="form-group">
                <label for="century"><i class="fas fa-hourglass-half"></i> 7. 世紀 (Century)</label>
                <input type="text" id="century" value="">
            </div>
            <div class="button-group">
                <button type="button" id="proceedToPart2" disabled><i class="fas fa-arrow-right"></i> 前往 Part 2: 線索文本轉換</button>
            </div>
            <div class="form-group">
                <div class="json-import-export-group">
                    <label for="importJsonFile_Part1"><i class="fas fa-file-import"></i> 匯入 JSON 數據 (用於編輯現有檔案)</label>
                    <input type="file" id="importJsonFile_Part1" accept=".json">
                    <button type="button" id="importJsonBtn_Part1" class="secondary"><i class="fas fa-upload"></i> 載入 JSON</button>
                    <button type="button" id="exportJsonBtn_Part1" class="secondary"><i class="fas fa-download"></i> 匯出 JSON</button>
                </div>
            </div>
        </section>

        <section id="part2" style="display: none;">
            <h2><i class="fas fa-file-alt"></i> Part 2: 線索文本轉換 (Source Text Transformation)</h2>
            <p>這一階段的目標是將原始文章轉化為遊戲中會呈現給玩家的「線索文本」。我們將從原始文章中找出關鍵字詞，並將其替換為通用性的「變數」，作為玩家需要猜測的謎題。</p>

            <h3>目標</h3>
            <p>從原始文章中找出關鍵的、需要被學習或猜測的字詞，並將其替換為通用性的「變數」。</p>

            <div class="form-group">
                <label for="originalText"><i class="fas fa-pencil-alt"></i> 1. 輸入原始線索文本 (文稿)<span class="required-star">*</span></label>
                <textarea id="originalText" placeholder="請將您預計用於題目的原始文章內容貼入此處。" required></textarea>
            </div>

            <div class="form-group">
                <label for="keyphrasesInput"><i class="fas fa-search"></i> 2. 找出關鍵字詞並替換為變數<span class="required-star">*</span></label>
                <textarea id="keyphrasesInput" placeholder="每行輸入一個關鍵詞，例如：&#10;韓戰&#10;美國&#10;家喻戶曉&#10;鈉" rows="5" required></textarea>
                <div class="word-count" id="keyphrasesInput_counter">0/無限制 字</div>
                <button type="button" id="generateKeyphraseCategories" disabled><i class="fas fa-cogs"></i> 確認關鍵詞並定義類別</button>
            </div>

            <div id="keyphraseCategorySection" style="display: none;">
                <h3><i class="fas fa-tag"></i> 3. 定義關鍵詞的「類別」變數</h3>
                <p>為每個選出的關鍵詞定義一個通用性的「類別」變數。這將用於生成<code>$[[某類]]</code>的格式。</p>
                <div class="table-wrapper">
                    <table id="keyphraseCategoryTable">
                        <thead>
                            <tr>
                                <th>關鍵詞</th>
                                <th>變數類別 (例如：某場戰役)<span class="required-star">*</span></th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- 動態生成行 -->
                        </tbody>
                    </table>
                </div>
                <button type="button" id="generateClueText" disabled><i class="fas fa-magic"></i> 生成線索文本預覽</button>
            </div>

            <div id="clueTextPreviewSection" style="display: none;">
                <h3><i class="fas fa-eye"></i> 4. 生成線索文本 (後臺) 預覽</h3>
                <p>這就是玩家在遊戲中會看到的線索文本，但其中關鍵詞已被隱藏。</p>
                <div class="preview-box" id="clueTextPreview"></div>
            </div>
            <div class="button-group">
                <button type="button" class="back" onclick="goToPart(1)"><i class="fas fa-undo"></i> 返回 Part 1</button>
                <button type="button" id="proceedToPart3" disabled><i class="fas fa-arrow-right"></i> 前往 Part 3: 設計答案與提示</button>
            </div>
            <div class="form-group">
                <div class="json-import-export-group">
                    <label for="importJsonFile_Part2"><i class="fas fa-file-import"></i> 匯入 JSON 數據 (用於編輯現有檔案)</label>
                    <input type="file" id="importJsonFile_Part2" accept=".json">
                    <button type="button" id="importJsonBtn_Part2" class="secondary"><i class="fas fa-upload"></i> 載入 JSON</button>
                    <button type="button" id="exportJsonBtn_Part2" class="secondary"><i class="fas fa-download"></i> 匯出 JSON</button>
                </div>
            </div>
        </section>

        <section id="part3" style="display: none;">
            <h2><i class="fas fa-lightbulb"></i> Part 3: 設計答案與提示系統 (核心鷹架)</h2>
            <p>這一階段的目標是為每個被隱藏的關鍵字詞提供不同層次（由具體到抽象）的提示，以及最終的完整答案和解釋。這將構成遊戲的核心學習鷹架。</p>
            <!-- Global AI Progress Indicator -->
            <div id="global-ai-progress">
                <span class="loading-spinner"></span>
                <span id="global-ai-progress-text">AI 正在生成所有提示...</span>
            </div>
            <button type="button" id="generateAllHintsAI" class="ai-button" style="margin-bottom: 20px;" disabled>
                <i class="fas fa-robot"></i> AI 生成所有提示
            </button>
            <div id="answersAndHintsForms">
                <!-- 動態生成每個關鍵詞的表單 -->
            </div>
            <div class="button-group">
                <button type="button" class="back" onclick="goToPart(2)"><i class="fas fa-undo"></i> 返回 Part 2</button>
                <button type="button" id="proceedToPart4" disabled><i class="fas fa-arrow-right"></i> 前往 Part 4: 建立知識卡組</button>
            </div>
            <div class="form-group">
                <div class="json-import-export-group">
                    <label for="importJsonFile_Part3"><i class="fas fa-file-import"></i> 匯入 JSON 數據 (用於編輯現有檔案)</label>
                    <input type="file" id="importJsonFile_Part3" accept=".json">
                    <button type="button" id="importJsonBtn_Part3" class="secondary"><i class="fas fa-upload"></i> 載入 JSON</button>
                    <button type="button" id="exportJsonBtn_Part3" class="secondary"><i class="fas fa-download"></i> 匯出 JSON</button>
                </div>
            </div>
        </section>

        <section id="part4" style="display: none;">
            <h2><i class="fas fa-cubes"></i> Part 4: 建立知識卡組 (Crafting Knowledge Card Sets)</h2>
            <p>知識卡是「時空學園」遊戲中的核心互動元素，包含一張「正確知識卡」和多張「錯誤知識卡」。玩家需要根據提示選擇正確的知識卡。</p>
            <p>請為每個關鍵詞設計一張正確知識卡及三張錯誤知識卡，作為遊戲中的選項。</p>
            <div id="knowledgeCardSets">
                <!-- 動態生成每個關鍵詞的表單 -->
            </div>
            <div class="button-group">
                <button type="button" class="back" onclick="goToPart(3)"><i class="fas fa-undo"></i> 返回 Part 3</button>
                <button type="button" id="proceedToPart5" disabled><i class="fas fa-arrow-right"></i> 前往 Part 5: 總結與匯出</button>
            </div>
            <div class="form-group">
                <div class="json-import-export-group">
                    <label for="importJsonFile_Part4"><i class="fas fa-file-import"></i> 匯入 JSON 數據 (用於編輯現有檔案)</label>
                    <input type="file" id="importJsonFile_Part4" accept=".json">
                    <button type="button" id="importJsonBtn_Part4" class="secondary"><i class="fas fa-upload"></i> 載入 JSON</button>
                    <button type="button" id="exportJsonBtn_Part4" class="secondary"><i class="fas fa-download"></i> 匯出 JSON</button>
                </div>
            </div>
        </section>

        <section id="part5" style="display: none;">
            <h2><i class="fas fa-database"></i> Part 5: 總結與匯出 (Review & Export)</h2>

            <h3><i class="fas fa-sitemap"></i> 總結設計邏輯</h3>
            <p>這個「時空學園」題目設計的核心是「多層次逐步揭示資訊」的教學策略，其流程如下：</p>
            <ol>
                <li><strong>初始挑戰:</strong> 玩家看到線索文本中的<code>$[[某類]]</code>變數，需要根據上下文自行判斷。</li>
                <li><strong>第一層提示 (文字內容):</strong> 如果玩家需要幫助，可以選擇查看最直接、最具體的提示。</li>
                <li><strong>第二層提示 (正確知識卡提示):</strong> 如果仍無法猜出，則提供更豐富一些、更具背景資訊的提示。</li>
                <li><strong>第三層提示 (整體鷹架提示):</strong> 如果仍有困難，則提供最廣泛、最概括的提示，幫助玩家從大方向思考。</li>
                <li><strong>最終解答與學習 (解答說明):</strong> 當玩家成功答對後，會得到完整的解釋，從而達到學習目的。</li>
            </ol>

            <h3><i class="fas fa-clipboard-check"></i> 審閱與匯出您的命題</h3>
            <p>請在這裡審閱您所設計的題目內容。您可以檢查所有欄位是否都已正確填寫，提示的層次是否合理，以及知識卡是否有效。</p>

            <div class="summary-section">
                <h3><i class="fas fa-file-alt"></i> 命題資料總覽</h3>
                <p><strong><i class="fas fa-clone"></i> 總知識卡數:</strong> <span id="totalKnowledgeCards">0</span></p>
                <p><strong><i class="fas fa-check-circle"></i> 正確知識卡數:</strong> <span id="correctKnowledgeCards">0</span></p>
                <div class="summary-content">
                    <pre id="fullDataSummary">點擊匯出按鈕查看完整數據...</pre>
                </div>
            </div>

            <div class="button-group">
                <button type="button" class="back" onclick="goToPart(4)"><i class="fas fa-undo"></i> 返回 Part 4</button>
                <button type="button" id="exportData"><i class="fas fa-download"></i> 匯出 JSON</button>
                <button type="button" id="exportWord"><i class="fas fa-file-word"></i> 匯出 Word (.doc)</button>
            </div>
            <div class="form-group">
                <div class="json-import-export-group">
                    <label for="importJsonFile_Part5"><i class="fas fa-file-import"></i> 匯入 JSON 數據 (用於編輯現有檔案)</label>
                    <input type="file" id="importJsonFile_Part5" accept=".json">
                    <button type="button" id="importJsonBtn_Part5" class="secondary"><i class="fas fa-upload"></i> 載入 JSON</button>
                    <button type="button" id="exportJsonBtn_Part5" class="secondary"><i class="fas fa-download"></i> 匯出 JSON</button>
                </div>
            </div>
        </section>
    </div>

    <!-- 吉祥物獨立於 footer 的背景層次 -->
    <div class="mascot-wrapper" id="mascotWrapper">
        <img src="image/LiyuChillGuy.svg" alt="時空學園 吉祥物" class="mascot-image">
    </div>

    <footer class="footer">
        <div class="left-content"></div>
        <div class="center-content">
            <span>Copyright © Liyuchiutiger Gongminshen</span>
        </div>
        <div class="right-content"></div>
    </footer>

    <!-- API Key Tutorial Modal -->
    <div id="apiKeyTutorialModal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-key"></i> 如何取得免費的 Google Gemini API 金鑰？</h3>
                <button class="modal-close" id="closeApiKeyTutorialModal"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-content-body">
                <ol style="list-style-type: decimal; margin-left: 20px; margin-top: 15px;">
                    <li style="margin-bottom: 10px;">前往 <a href="https://aistudio.google.com/app/apikey" target="_blank" rel="noopener noreferrer">Google AI Studio 的 API 金鑰頁面</a>。</li>
                    <li style="margin-bottom: 10px;">使用您的 Google 帳號登入。</li>
                    <li style="margin-bottom: 10px;">點擊頁面上的 <strong>「建立 API 金鑰」(Create API key)</strong> 按鈕。</li>
                    <li style="margin-bottom: 10px;">系統會立即產生一組新的金鑰。點擊金鑰旁邊的複製圖示。</li>
                    <li>回到本頁面，將複製的金鑰貼到輸入框中即可！</li>
                </ol>
                <p style="color: var(--ui-error-red); font-size: 0.9em; margin-top: 20px;"><strong>提醒：</strong>請妥善保管您的 API 金鑰，不要與他人分享。</p>
            </div>
        </div>
    </div>

    <!-- Help Modal (Draggable and Resizable) -->
    <div id="help-modal" style="display: none;">
        <div class="modal-header">
            <h3><i class="fas fa-circle-info"></i> 系統使用說明書</h3>
            <button class="modal-close" id="close-help-modal"><i class="fas fa-times"></i></button>
        </div>
        <div class="modal-content-body">
            <p>本系統旨在協助您設計「時空學園」遊戲題目，遵循「多層次逐步揭示資訊」的教育理念。</p>

            <h4>系統操作流程簡述：</h4>
            <ol>
                <li>**Part 1: 基礎任務設定**
                    <ul>
                        <li>填寫題目所需的基礎資訊，如任務名稱、學科、難度等級等。這些資訊會影響後續 AI 生成的內容。</li>
                        <li>可匯入/匯出 JSON 數據，方便保存和修改進度。</li>
                    </ul>
                </li>
                <li>**Part 2: 線索文本轉換**
                    <ul>
                        <li>貼入您的原始文章作為線索文本。</li>
                        <li>輸入文章中的**關鍵字詞**，系統會引導您定義這些詞的「變數類別」（例如，將「韓戰」替換為「某場戰役」）。</li>
                        <li>系統會生成一個「線索文本預覽」，其中關鍵字詞會被替換為 `$[[變數類別]]` 的形式。</li>
                    </ul>
                </li>
                <li>**Part 3: 設計答案與提示系統**
                    <ul>
                        <li>為每個關鍵詞設計不同層次的提示：
                            <ol>
                                <li>**最終解答說明：** 完整的解釋。</li>
                                <li>**第一層提示 (12字內)：** 最直接的文字提示。</li>
                                <li>**第二層提示 (25字內)：** 正確知識卡鷹架提示，提供背景或情境。</li>
                                <li>**第三層提示 (25字內)：** 最廣泛的整體鷹架提示，幫助思考方向。</li>
                            </ol>
                        </li>
                        <li>可以使用 **「AI 生成提示」** 按鈕來協助生成這些內容。</li>
                    </ul>
                </li>
                <li>**Part 4: 建立知識卡組**
                    <ul>
                        <li>為每個關鍵詞設計一張**正確知識卡**和三張**錯誤知識卡**。</li>
                        <li>每張卡片包含名稱、學科、類別、文字內容（定義）、圖片（可選）和外部資訊（可選）。</li>
                        <li>**錯誤卡片名稱：** 需根據卡片名稱本身提供**客觀定義**。AI 生成功能會依此原則提供建議。</li>
                        <li>圖片與外部資訊預設收合，點擊可展開。</li>
                    </ul>
                </li>
                <li>**Part 5: 總結與匯出**
                    <ul>
                        <li>審閱所有題目內容，檢查完整性與合理性。</li>
                        <li>可匯出為 JSON 格式（便於系統再次載入）或 Word 格式（便於閱讀和打印）。</li>
                    </ul>
                </li>
            </ol>

            <h4>AI 功能說明：</h4>
            <ul>
                <li>**API 金鑰：** 使用 Google Gemini API，需要您提供個人金鑰。金鑰只儲存在您的瀏覽器。</li>
                <li>**AI 生成按鈕：**
                    <ul>
                        <li>在 Part 3，可以「AI 生成所有提示」或單獨為每個關鍵詞「AI 生成提示」。</li>
                        <li>在 Part 4，可以單獨為每張錯誤知識卡生成「文字內容 (定義)」。</li>
                    </ul>
                </li>
                <li>**進度提示：** AI 處理時會有視覺上的進度提示和遮罩，避免等待焦慮。</li>
            </ul>

            <h4>《時空學園》官方網站：</h4>
            <p><a href="https://sites.google.com/aiv.com.tw/time-warrior-academy/" target="_blank" rel="noopener noreferrer">https://sites.google.com/aiv.com.tw/time-warrior-academy/</a></p>

            <h4>《時空學園》命題設計大禮包下載：</h4>
            <p><a href="https://reurl.cc/86Lv6j" target="_blank" rel="noopener noreferrer">https://reurl.cc/86Lv6j</a></p>

            <h4>《時空學園》範例檔JSON下載：</h4>
            <a href="file/時空學園命題範例_韓國部隊鍋(命題：蘇健倫老師).json" download>時空學園命題範例_韓國部隊鍋(命題：蘇健倫老師).json</a></p>

        </div>
    </div>

    <!-- Toast Container -->
    <div id="toast-container"></div>


    <!-- tsParticles CDN - Re-introduced -->
    <script src="https://cdn.jsdelivr.net/npm/tsparticles-slim@2.12.0/tsparticles.slim.min.js"></script>
    <!-- FileSaver.js for saving files -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script>
        const missionData = {}; // 全局數據對象
        let keyphrases = []; // 用於存儲 Part 2 提取的關鍵詞和類別 [{original: "...", category: "...", color: "..."}]

        // 所有學科選項
        const ALL_SUBJECTS = ["國語", "英語", "數學", "自然", "社會", "國文", "英文", "理化", "生物", "地科", "歷史", "地理", "公民"];
        // 關鍵詞顏色循環
        const KEYWORD_COLORS = [
            'var(--answer-red)', 
            'var(--answer-green)', 
            'var(--answer-blue)', 
            'var(--answer-purple)'
        ];

        // API Key related
        const apiKeyInput = document.getElementById('user-api-key');
        let currentApiKey = localStorage.getItem('geminiApiKey') || '';
        if (apiKeyInput) apiKeyInput.value = currentApiKey;

        apiKeyInput.addEventListener('input', () => {
            currentApiKey = apiKeyInput.value.trim();
            localStorage.setItem('geminiApiKey', currentApiKey);
            checkAllCompletionStates(); // Re-check button states as API key is crucial
        });

        document.getElementById('show-api-tutorial').addEventListener('click', (e) => {
            e.preventDefault(); // Prevent default link behavior
            document.getElementById('apiKeyTutorialModal').style.display = 'flex';
        });
        document.getElementById('closeApiKeyTutorialModal').addEventListener('click', () => {
            document.getElementById('apiKeyTutorialModal').style.display = 'none';
        });

        // Gemini API Constants - ONLY TEXT GENERATION
        const GEMINI_API_URL_TEXT = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent';
        const MAX_RETRIES = 3;
        const INITIAL_BACKOFF = 1500; // 1.5 seconds

        async function fetchWithGeminiRetry(apiUrl, payload, retries = MAX_RETRIES, backoff = INITIAL_BACKOFF) {
            if (!currentApiKey) {
                showToast("請輸入有效的 Google Gemini API 金鑰。", 'error');
                throw new Error("請輸入有效的 Google Gemini API 金鑰。");
            }
            const fullUrl = `${apiUrl}?key=${currentApiKey}`;

            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(fullUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({}));
                        console.error('API 錯誤:', errorData);
                        if (response.status === 429 && i < retries - 1) { // Too many requests, retry
                            showToast(`請求頻率過高。將在 ${backoff / 1000} 秒後重試...`, 'info');
                            await new Promise(res => setTimeout(res, backoff));
                            backoff *= 2; // Exponential backoff
                            continue;
                        } else if (response.status === 401) {
                            showToast(`API 請求失敗：未授權。請確認您的 API 金鑰是否有效。`, 'error');
                            throw new Error(`API 請求失敗，狀態碼 401：未授權。請確認您的 API 金鑰是否有效。`);
                        }
                        showToast(`API 請求失敗，狀態碼 ${response.status}: ${errorData.error?.message || '未知錯誤'}`, 'error');
                        throw new Error(`API 請求失敗，狀態碼 ${response.status}: ${errorData.error?.message || '未知錯誤'}`);
                    }

                    return await response.json();
                } catch (error) {
                    if (i < retries - 1) {
                        showToast(`API 呼叫失敗。將在 ${backoff / 1000} 秒後重試...`, 'error');
                        await new Promise(res => setTimeout(res, backoff));
                        backoff *= 2;
                    } else {
                        throw error;
                    }
                }
            }
            throw new Error(`API 請求在 ${retries} 次重試後仍然失敗。`);
        }

        // NEW: Toast Message Function
        const toastContainer = document.getElementById('toast-container');
        function showToast(message, type = 'info', duration = 3000) {
            const toast = document.createElement('div');
            toast.classList.add('toast', type);

            let iconClass = '';
            if (type === 'success') iconClass = 'fas fa-check-circle';
            else if (type === 'error') iconClass = 'fas fa-exclamation-circle';
            else iconClass = 'fas fa-info-circle';

            toast.innerHTML = `<i class="${iconClass}"></i><span>${message}</span>`;
            
            toastContainer.appendChild(toast);

            // Trigger reflow to ensure animation starts
            void toast.offsetWidth; 
            toast.classList.add('show');

            setTimeout(() => {
                toast.classList.remove('show');
                toast.addEventListener('transitionend', () => toast.remove());
            }, duration);
        }

        // 輔助函數：字數計算器
        function setupWordCounter(textareaId, counterId, limit) {
            const textarea = document.getElementById(textareaId);
            const counter = document.getElementById(counterId);

            function updateCounter() {
                if (!textarea || !counter) return; // Add null check for robustness
                const currentLength = textarea.value.length;
                counter.textContent = `${currentLength}/${limit === -1 ? '無限制' : limit} 字`;
                if (limit !== -1 && currentLength > limit) {
                    counter.style.color = 'var(--ui-error-red)';
                } else {
                    counter.style.color = 'var(--text-medium)';
                }
                checkAllCompletionStates();
            }

            if (textarea && counter) {
                textarea.addEventListener('input', updateCounter);
                updateCounter(); // 初始化時更新一次
            }
        }

        // 輔助函數：生成隨機ID
        function generateUniqueId() {
            return 'id_' + Math.random().toString(36).substr(2, 9);
        }

        // 輔助函數：顯示/隱藏區塊
        function toggleSection(sectionId, show) {
            document.getElementById(sectionId).style.display = show ? 'block' : 'none';
        }

        // NEW: AI Overlay functions
        function showAIOverlay(element, message = "AI 正在生成...") {
            if (!element) return;
            // Check if an overlay already exists
            let overlay = element.querySelector('.ai-overlay');
            if (!overlay) {
                overlay = document.createElement('div');
                overlay.classList.add('ai-overlay');
                element.style.position = 'relative'; // Ensure parent is positioned for absolute overlay
                element.appendChild(overlay);
            }
            overlay.innerHTML = `<span class="loading-spinner"></span><span class="ai-overlay-text">${message}</span>`;
            
            // Trigger reflow to ensure animation starts if not already active
            if (!overlay.classList.contains('active')) {
                void overlay.offsetWidth; 
                overlay.classList.add('active');
            } else {
                 // If already active, just update text
                 updateAIOverlayText(element, message);
            }
        }

        function hideAIOverlay(element) {
            if (!element) return;
            const overlay = element.querySelector('.ai-overlay');
            if (overlay) {
                overlay.classList.remove('active');
                overlay.addEventListener('transitionend', () => overlay.remove(), { once: true });
            }
        }

        function updateAIOverlayText(element, message) {
            if (!element) return;
            const textSpan = element.querySelector('.ai-overlay-text');
            if (textSpan) {
                textSpan.textContent = message;
            }
        }

        // 導航到指定 Part
        function goToPart(partNum) {
            const currentPart = document.querySelector('section:not([style*="display: none"])');
            if (currentPart) {
                const currentPartId = currentPart.id;
                // 根據當前 Part 保存數據
                if (currentPartId === 'part1') collectPart1Data();
                if (currentPartId === 'part2') collectPart2Data();
                if (currentPartId === 'part3') missionData.part3 = getPart3DataFromDOM();
                if (currentPartId === 'part4') missionData.part4 = getPart4DataFromDOM();
            }

            // 先隱藏所有 Part
            for (let i = 1; i <= 5; i++) {
                toggleSection(`part${i}`, false);
            }
            // 顯示目標 Part
            toggleSection(`part${partNum}`, true);

            // 當返回時，或首次進入時，根據 missionData 重新渲染動態表單
            initializeAriaAttributes(); // Always re-initialize ARIA when switching parts

            if (partNum === 2) {
                if (missionData.part2?.originalText && missionData.part2?.keyphrases) {
                    originalTextarea.value = missionData.part2.originalText;
                    keyphrases = missionData.part2.keyphrases; // 重新載入 keyphrases 數組
                    keyphrasesTextarea.value = keyphrases.map(kp => kp.original).join('\n');
                    generateKeyphraseCategoriesBtn.click(); // 觸發生成關鍵詞表格
                    setTimeout(() => { // 稍作遲延，確保 DOM 已生成
                        keyphrases.forEach((kp, idx) => {
                            const inputElem = document.getElementById(`keyphrase_category_input_${idx}`);
                            if (inputElem) {
                                inputElem.value = kp.category;
                                inputElem.style.color = kp.color; // 設置文本顏色
                            }
                        });
                        generateClueTextBtn.click(); // 觸發生成線索文本預覽
                    }, 100); // Short delay
                }
            } else if (partNum === 3) {
                generatePart3Forms();
            } else if (partNum === 4) {
                collectPart1Data(); // Re-collect Part 1 data to ensure subject list is fresh
                generatePart4Forms(); // This is the crucial fix for all keyphrases
            } else if (partNum === 5) {
                checkPart4Completion(); // Update Part 5 statistics
            }
            
            checkAllCompletionStates(); // Ensure button states are re-checked after navigation
        }

        // 輔助函數：圖片預覽
        function setupImagePreview(fileInputId, imgPreviewId, urlInputId) {
            const fileInput = document.getElementById(fileInputId);
            const imgPreview = document.getElementById(imgPreviewId);
            const urlInput = document.getElementById(urlInputId);

            if (fileInput) {
                fileInput.addEventListener('change', function() {
                    if (this.files && this.files[0]) {
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            imgPreview.src = e.target.result;
                            imgPreview.style.display = 'block';
                            imgPreview.classList.remove('loading');
                            if (urlInput) urlInput.value = '';
                        };
                        reader.readAsDataURL(this.files[0]);
                    } else {
                        if (!urlInput || urlInput.value === '') {
                            imgPreview.src = '';
                            imgPreview.style.display = 'none';
                            imgPreview.classList.remove('loading');
                        }
                    }
                });
            }
            if (urlInput) {
                urlInput.addEventListener('input', function() {
                    imgPreview.src = this.value;
                    imgPreview.style.display = this.value ? 'block' : 'none';
                    imgPreview.classList.remove('loading');
                    if (fileInput) fileInput.value = '';
                });
            }
        }

        // NEW: Accessibility (A11y) - ARIA attributes for required fields
        function initializeAriaAttributes() {
            // Remove existing aria-required to prevent duplicates on dynamic content
            document.querySelectorAll('[aria-required]').forEach(el => el.removeAttribute('aria-required'));

            document.querySelectorAll('label').forEach(label => {
                if (label.querySelector('.required-star')) {
                    const inputId = label.getAttribute('for');
                    if (inputId) {
                        const inputElement = document.getElementById(inputId);
                        if (inputElement) {
                            inputElement.setAttribute('aria-required', 'true');
                        }
                    } else { // Handle cases where label is for a group or adjacent input
                        const directInput = label.closest('.form-group')?.querySelector('input[required], select[required], textarea[required]');
                        if (directInput) {
                            directInput.setAttribute('aria-required', 'true');
                        }
                    }
                }
            });
            // Directly set aria-required for custom inputs if they are visible/required
            if (customMainSubjectInputGroup.style.display === 'flex') {
                document.getElementById('customMainSubject').setAttribute('aria-required', 'true');
            }
            // Custom other subject is not strictly required by itself
        }

        // =========================================================
        // Part 1 相關函數
        // =========================================================
        const missionTitleInput = document.getElementById('missionTitle');
        const mainSubjectSelect = document.getElementById('mainSubject');
        const customMainSubjectInputGroup = document.getElementById('customMainSubjectInputGroup');
        const customMainSubjectInput = document.getElementById('customMainSubject');
        const gradeLevelSelect = document.getElementById('gradeLevel');
        const semesterLevelSelect = document.getElementById('semesterLevel');
        
        const otherSubjectsCheckboxesDiv = document.getElementById('otherSubjectsCheckboxes');
        const customOtherSubjectInputGroup = document.getElementById('customOtherSubjectInputGroup');
        const customOtherSubjectInput = document.getElementById('customOtherSubject');

        const proceedToPart2Btn = document.getElementById('proceedToPart2');


        // 生成其他學科複選框
        function generateOtherSubjectsCheckboxes() {
            let selectedMainSubject = mainSubjectSelect.value;
            if (selectedMainSubject === '其他') {
                selectedMainSubject = customMainSubjectInput.value.trim();
            }

            const checkedOtherSubjects = new Set();
            if (missionData.part1 && missionData.part1.otherSubjects) {
                missionData.part1.otherSubjects.forEach(sub => checkedOtherSubjects.add(sub));
            }
            // Retain currently checked non-custom "Other" subjects from DOM
            Array.from(otherSubjectsCheckboxesDiv.querySelectorAll('input[type="checkbox"]:checked'))
                                            .map(cb => cb.value)
                                            .filter(val => val !== '其他' && ALL_SUBJECTS.includes(val))
                                            .forEach(val => checkedOtherSubjects.add(val));


            otherSubjectsCheckboxesDiv.innerHTML = '';

            const filteredSubjects = ALL_SUBJECTS.filter(subject => subject !== selectedMainSubject);

            filteredSubjects.forEach(subject => {
                const checkboxId = `subSubject_${subject}`;
                const isChecked = checkedOtherSubjects.has(subject) ? 'checked' : '';
                otherSubjectsCheckboxesDiv.insertAdjacentHTML('beforeend', `
                    <input type="checkbox" id="${checkboxId}" value="${subject}" ${isChecked}> 
                    <label for="${checkboxId}" style="display: inline;">${subject}</label>
                `);
            });

            const otherCheckboxId = `subSubject_其他`;
            let isOtherCheckedFromData = false;
            let customOtherSubjectValues = '';

            if (missionData.part1 && missionData.part1.otherSubjects) {
                const nonStandardSubs = missionData.part1.otherSubjects.filter(sub => !ALL_SUBJECTS.includes(sub));
                if (nonStandardSubs.length > 0) {
                    isOtherCheckedFromData = true;
                    customOtherSubjectValues = nonStandardSubs.join(',');
                }
            }
            // Determine final checked state for "Other" checkbox
            let finalIsOtherChecked = isOtherCheckedFromData || (customOtherSubjectInput.value.trim().length > 0 && !ALL_SUBJECTS.includes(customMainSubjectInput.value.trim())); // Use customMainSubjectInput for consistency if selected

            otherSubjectsCheckboxesDiv.insertAdjacentHTML('beforeend', `
                <input type="checkbox" id="${otherCheckboxId}" value="其他" ${finalIsOtherChecked ? 'checked' : ''}> 
                <label for="${otherCheckboxId}" style="display: inline;">其他 (請輸入)</label>
            `);
            
            if (finalIsOtherChecked) {
                customOtherSubjectInputGroup.style.display = 'flex';
                if (customOtherSubjectValues) {
                    customOtherSubjectInput.value = customOtherOtherSubjectValues;
                }
            } else {
                customOtherSubjectInputGroup.style.display = 'none';
                customOtherSubjectInput.value = '';
            }
            checkAllCompletionStates();
        }

        mainSubjectSelect.addEventListener('change', () => {
            if (mainSubjectSelect.value === '其他') {
                customMainSubjectInputGroup.style.display = 'flex';
                customMainSubjectInput.focus();
            } else {
                customMainSubjectInputGroup.style.display = 'none';
                customMainSubjectInput.value = '';
            }
            generateOtherSubjectsCheckboxes();
            initializeAriaAttributes(); // Re-initialize ARIA attributes on dynamic elements
        });
        
        customMainSubjectInput.addEventListener('input', () => {
            generateOtherSubjectsCheckboxes();
            initializeAriaAttributes(); // Re-initialize ARIA attributes on dynamic elements
        });

        otherSubjectsCheckboxesDiv.addEventListener('change', (event) => {
            if (event.target.id === 'subSubject_其他') {
                if (event.target.checked) {
                    customOtherSubjectInputGroup.style.display = 'flex';
                    customOtherSubjectInput.focus();
                } else {
                    customOtherSubjectInputGroup.style.display = 'none';
                    customOtherSubjectInput.value = '';
                }
            }
            checkAllCompletionStates();
        });

        // Part 1 的必填字段監聽和按鈕啟用/禁用
        function checkPart1Completion() {
            let isValid = true;

            if (!missionTitleInput.value.trim()) isValid = false;

            let currentMainSubject = mainSubjectSelect.value;
            if (!currentMainSubject || currentMainSubject === "") isValid = false;
            if (currentMainSubject === '其他' && !customMainSubjectInput.value.trim()) isValid = false;

            if (!gradeLevelSelect.value || gradeLevelSelect.value === "") isValid = false;
            if (!semesterLevelSelect.value || semesterLevelSelect.value === "") isValid = false;
            
            [missionTitleInput, mainSubjectSelect, gradeLevelSelect, semesterLevelSelect].forEach(input => {
                if (!input.value.trim() || input.value === "") {
                    input.style.borderColor = 'var(--ui-error-red)';
                } else {
                    input.style.borderColor = 'var(--border-light)';
                }
            });
            if (mainSubjectSelect.value === '其他') {
                if (!customMainSubjectInput.value.trim()) {
                    customMainSubjectInput.style.borderColor = 'var(--ui-error-red)';
                } else {
                    customMainSubjectInput.style.borderColor = 'var(--border-light)';
                }
            }

            proceedToPart2Btn.disabled = !isValid;
            return isValid;
        }

        missionTitleInput.addEventListener('input', checkPart1Completion);
        mainSubjectSelect.addEventListener('change', checkPart1Completion);
        customMainSubjectInput.addEventListener('input', checkPart1Completion); 
        gradeLevelSelect.addEventListener('change', checkPart1Completion);
        semesterLevelSelect.addEventListener('change', checkPart1Completion);

        document.getElementById('proceedToPart2').addEventListener('click', () => {
            if (checkPart1Completion()) {
                collectPart1Data();
                goToPart(2);
            } else {
                showToast('請填寫 Part 1 的所有必填欄位！', 'error');
            }
        });

        function collectPart1Data() {
            let mainSub = mainSubjectSelect.value;
            if (mainSub === '其他') {
                mainSub = customMainSubjectInput.value.trim();
            }

            let otherSubs = Array.from(otherSubjectsCheckboxesDiv.querySelectorAll('input[type="checkbox"]:checked'))
                               .map(cb => cb.value)
                               .filter(val => val !== '其他');

            if (document.getElementById('subSubject_其他') && document.getElementById('subSubject_其他').checked) {
                const customVal = customOtherSubjectInput.value.trim();
                if (customVal) {
                    customVal.split(',').map(s => s.trim()).filter(s => s.length > 0)
                             .forEach(customSub => {
                                 if (!otherSubs.includes(customSub)) {
                                     otherSubs.push(customSub);
                                 }
                             });
                }
            }
            otherSubs = otherSubs.filter(sub => sub !== mainSub);

            missionData.part1 = {
                missionTitle: document.getElementById('missionTitle').value.trim(),
                mainSubject: mainSub,
                otherSubjects: otherSubs,
                curriculumGuidelines: document.getElementById('curriculumGuidelines').value.trim(),
                gradeLevel: document.getElementById('gradeLevel').value,
                semesterLevel: document.getElementById('semesterLevel').value,
                location: document.getElementById('location').value.trim(),
                century: document.getElementById('century').value.trim()
            };
        }
        // =========================================================
        // Part 2 相關函數
        // =========================================================
        const originalTextarea = document.getElementById('originalText');
        const keyphrasesTextarea = document.getElementById('keyphrasesInput');
        const generateKeyphraseCategoriesBtn = document.getElementById('generateKeyphraseCategories');
        const keyphraseCategoryTableBody = document.getElementById('keyphraseCategoryTable').querySelector('tbody');
        const generateClueTextBtn = document.getElementById('generateClueText');
        const clueTextPreviewDiv = document.getElementById('clueTextPreview');
        const proceedToPart3Btn = document.getElementById('proceedToPart3');

        function checkGenerateKeyphraseCategoriesBtn() {
            const originalTextFilled = originalTextarea.value.trim().length > 0;
            const keyphrasesFilled = keyphrasesTextarea.value.trim().length > 0;
            
            originalTextarea.style.borderColor = originalTextFilled ? 'var(--border-light)' : 'var(--ui-error-red)';
            keyphrasesTextarea.style.borderColor = keyphrasesFilled ? 'var(--border-light)' : 'var(--ui-error-red)';

            generateKeyphraseCategoriesBtn.disabled = !(originalTextFilled && keyphrasesFilled);
            return (originalTextFilled && keyphrasesFilled);
        }
        originalTextarea.addEventListener('input', checkGenerateKeyphraseCategoriesBtn);
        keyphrasesTextarea.addEventListener('input', checkGenerateKeyphraseCategoriesBtn);

        document.getElementById('generateKeyphraseCategories').addEventListener('click', () => {
            if (!checkGenerateKeyphraseCategoriesBtn()) {
                showToast('請確保原始線索文本和關鍵詞都已填寫！', 'error');
                return;
            }

            const keyphrasesInput = keyphrasesTextarea.value.split('\n').map(s => s.trim()).filter(s => s.length > 0);
            if (keyphrasesInput.length === 0) {
                showToast('請輸入關鍵詞！', 'error');
                return;
            }

            keyphraseCategoryTableBody.innerHTML = '';
            // Reset keyphrases with only 'original', 'category' (empty), and 'color'
            keyphrases = keyphrasesInput.map(kp => ({ original: kp, category: '', color: '' })); 

            // Restore 'category' from missionData if available (e.g., after JSON import or back navigation)
            if (missionData.part2 && missionData.part2.keyphrases) {
                keyphrases.forEach(kp => {
                    const existingKp = missionData.part2.keyphrases.find(item => item.original === kp.original);
                    if (existingKp) {
                        kp.category = existingKp.category;
                    }
                });
            }

            keyphrases.forEach((kp, idx) => {
                kp.color = KEYWORD_COLORS[idx % KEYWORD_COLORS.length];
                
                const row = keyphraseCategoryTableBody.insertRow();
                const cell1 = row.insertCell(0);
                const cell2 = row.insertCell(1);

                cell1.textContent = kp.original;
                

                const inputId = `keyphrase_category_input_${idx}`;
                const categoryInput = document.createElement('input');
                categoryInput.type = 'text';
categoryInput.id = inputId;
                categoryInput.value = kp.category || '';
                categoryInput.placeholder = '請定義變數類別*';
                categoryInput.required = true;
                categoryInput.style.borderLeft = `5px solid ${kp.color}`;
                categoryInput.style.paddingLeft = '5px';
                categoryInput.style.color = kp.color; // Set text color for the input
                categoryInput.dataset.keywordColor = kp.color;
                categoryInput.dataset.originalIndex = idx;
                categoryInput.setAttribute('aria-required', 'true');

                categoryInput.addEventListener('input', (event) => {
                    const updatedIndex = parseInt(event.target.dataset.originalIndex, 10);
                    if (!isNaN(updatedIndex) && keyphrases[updatedIndex]) {
                        keyphrases[updatedIndex].category = event.target.value.trim();
                    }
                    checkGenerateClueTextBtn();
                });
                cell2.appendChild(categoryInput);
            });
            // Update missionData.part2.keyphrases with the newly generated structure
            missionData.part2 = { ...missionData.part2, keyphrases: keyphrases.map(kp => ({ original: kp.original, category: kp.category, color: kp.color })) };

            toggleSection('keyphraseCategorySection', true);
            initializeAriaAttributes(); // Re-initialize ARIA for newly generated inputs
            checkGenerateClueTextBtn();
        });

        function checkGenerateClueTextBtn() {
            let allCategoriesDefined = true;
            if (keyphrases.length === 0) {
                allCategoriesDefined = false;
            } else {
                keyphrases.forEach((kp, idx) => {
                    const inputElem = document.getElementById(`keyphrase_category_input_${idx}`);
                    const isDefined = inputElem && inputElem.value.trim().length > 0;
                    if (!isDefined) {
                        allCategoriesDefined = false;
                        if (inputElem) inputElem.style.borderColor = 'var(--ui-error-red)';
                    } else {
                        if (inputElem) inputElem.style.borderColor = 'var(--border-light)';
                    }
                });
            }
            generateClueTextBtn.disabled = !allCategoriesDefined;
            return allCategoriesDefined;
        }

        document.getElementById('generateClueText').addEventListener('click', () => {
            if (!checkGenerateClueTextBtn()) {
                showToast('請為所有關鍵詞定義變數類別！', 'error');
                return;
            }

            let clueText = originalTextarea.value;
            keyphrases.forEach((kp, idx) => {
                const regex = new RegExp(kp.original.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'g');
                clueText = clueText.replace(regex, `<span class="highlight color-${idx % KEYWORD_COLORS.length}">$[[${kp.category}]]</span>`);
            });
            // Store processed HTML and raw text
            missionData.part2 = { 
                ...missionData.part2, 
                clueTextHtml: clueText, 
                originalText: originalTextarea.value,
                keyphrases: keyphrases.map(kp => ({ original: kp.original, category: kp.category, color: kp.color }))
            };


            clueTextPreviewDiv.innerHTML = clueText;
            toggleSection('clueTextPreviewSection', true);
            checkProceedToPart3Btn();
        });

        function collectPart2Data() {
            missionData.part2 = missionData.part2 || {};
            missionData.part2.originalText = originalTextarea.value;
            const updatedKeyphrases = keyphrases.map((kp, idx) => {
                const inputElem = document.getElementById(`keyphrase_category_input_${idx}`);
                return { original: kp.original, category: inputElem ? inputElem.value.trim() : kp.category, color: kp.color };
            });
            missionData.part2.keyphrases = updatedKeyphrases;
            missionData.part2.clueTextHtml = clueTextPreviewDiv.innerHTML;
        }

        function checkProceedToPart3Btn() {
            proceedToPart3Btn.disabled = !clueTextPreviewDiv.innerHTML.trim();
            return !!clueTextPreviewDiv.innerHTML.trim();
        }

        document.getElementById('proceedToPart3').addEventListener('click', () => {
            if (checkProceedToPart3Btn()) {
                goToPart(3);
            } else {
                showToast('請先生成線索文本預覽！', 'error');
            }
        });


        // =========================================================
        // Part 3: 生成答案與提示表單 (包含 AI 功能)
        // =========================================================
        const answersAndHintsFormsContainer = document.getElementById('answersAndHintsForms');
        const proceedToPart4Btn = document.getElementById('proceedToPart4');
        const generateAllHintsAIButton = document.getElementById('generateAllHintsAI');
        const globalAiProgress = document.getElementById('global-ai-progress');
        const globalAiProgressText = document.getElementById('global-ai-progress-text');


        let isGeneratingHintsAI = false;

        function getPart3DataFromDOM() {
            const currentPart3Data = {};
            keyphrases.forEach((kp, index) => {
                const formId = `hints_form_${index}`;
                const explanationElem = document.getElementById(`${formId}_explanation`);
                const hint1Elem = document.getElementById(`${formId}_hint1`);
                const hint2Elem = document.getElementById(`${formId}_hint2`);
                const hint3Elem = document.getElementById(`${formId}_hint3`);

                if (explanationElem && hint1Elem && hint2Elem && hint3Elem) {
                    currentPart3Data[kp.original] = {
                        explanation: explanationElem.value,
                        hint1_textContent: hint1Elem.value,
                        hint2_knowledgeCardScaffold: hint2Elem.value,
                        hint3_overallScaffoldingHint: hint3Elem.value
                    };
                }
            });
            return currentPart3Data;
        }

        async function generateHintsForSingleKeyphrase(kp, index) {
            const formId = `hints_form_${index}`;
            const knowledgeCard = document.querySelector(`#${formId}.knowledge-card`);
            const explanationElem = document.getElementById(`${formId}_explanation`);
            const hint1Elem = document.getElementById(`${formId}_hint1`);
            const hint2Elem = document.getElementById(`${formId}_hint2`);
            const hint3Elem = document.getElementById(`${formId}_hint3`);
            const aiButton = document.getElementById(`${formId}_generate_ai_button`);

            if (!knowledgeCard || !explanationElem || !hint1Elem || !hint2Elem || !hint3Elem || !aiButton) {
                console.warn(`Missing DOM elements for keyphrase ${kp.original}. Skipping AI generation.`);
                return;
            }

            aiButton.disabled = true;
            const originalButtonContent = aiButton.innerHTML;
            aiButton.innerHTML = `<span class="loading-spinner"></span> 生成中...`;
            showAIOverlay(knowledgeCard, `正在生成 "${kp.original}" 的提示...`);

            try {
                const prompt = `請為以下關鍵詞和類別生成教育內容：\n關鍵詞: ${kp.original}\n變數類別: ${kp.category}\n\n請以繁體中文提供以下四項內容，並確保其長度符合要求：\n1. 最終解答說明 (Full Explanation): 詳細解釋關鍵詞。\n2. 第一層提示 (Most Direct Hint): 12字以內的直接提示。\n3. 第二層提示 (Knowledge Card Scaffold): 25字以內的背景或情境提示。\n4. 第三層提示 (Overall Scaffolding Hint): 25字以內的大方向或概括性提示。\n\n請以 JSON 格式回傳，例如：\n{\n  "explanation": "...",\n  "hint1": "...",\n  "hint2": "...",\n  "hint3": "..."\n}`;

                const payload = {
                    contents: [{ parts: [{ text: prompt }] }],
                    generationConfig: {
                        responseMimeType: "application/json"
                    },
                    safetySettings: [
                        { category: "HARM_CATEGORY_HATE_SPEECH", threshold: "BLOCK_NONE" },
                        { category: "HARM_CATEGORY_SEXUALLY_EXPLICIT", threshold: "BLOCK_NONE" },
                        { category: "HARM_CATEGORY_DANGEROUS_CONTENT", threshold: "BLOCK_NONE" },
                        { category: "HARM_CATEGORY_HARASSMENT", threshold: "BLOCK_NONE" }
                    ]
                };

                const result = await fetchWithGeminiRetry(GEMINI_API_URL_TEXT, payload);
                const jsonText = result.candidates?.[0]?.content?.parts?.[0]?.text;

                if (jsonText) {
                    const data = JSON.parse(jsonText);
                    explanationElem.value = data.explanation || '';
                    hint1Elem.value = data.hint1 || '';
                    hint2Elem.value = data.hint2 || '';
                    hint3Elem.value = data.hint3 || '';

                    explanationElem.dispatchEvent(new Event('input'));
                    hint1Elem.dispatchEvent(new Event('input'));
                    hint2Elem.dispatchEvent(new Event('input'));
                    hint3Elem.dispatchEvent(new Event('input'));
                    showToast(`"${kp.original}" 的提示已生成。`, 'success');
                } else {
                    throw new Error("AI 未返回有效的 JSON 格式內容。");
                }
            } catch (error) {
                showToast(`AI 生成 "${kp.original}" 的提示失敗: ${error.message}`, 'error');
                console.error(`AI 生成 "${kp.original}" 的提示失敗:`, error);
            } finally {
                aiButton.disabled = false;
                aiButton.innerHTML = originalButtonContent;
                hideAIOverlay(knowledgeCard);
                checkAllCompletionStates();
            }
        }

        async function generateAllHintsAIHandler() {
            if (isGeneratingHintsAI) return;
            isGeneratingHintsAI = true;
            generateAllHintsAIButton.disabled = true;
            generateAllHintsAIButton.innerHTML = `<span class="loading-spinner"></span> AI 生成中...`;
            globalAiProgress.classList.add('active');
            globalAiProgressText.textContent = "AI 正在生成所有提示...";


            try {
                for (let i = 0; i < keyphrases.length; i++) {
                    const kp = keyphrases[i];
                    globalAiProgressText.textContent = `AI 正在生成 "${kp.original}" 的提示 (${i + 1}/${keyphrases.length})...`;
                    await generateHintsForSingleKeyphrase(kp, i);
                    await new Promise(resolve => setTimeout(resolve, 500));
                }
                showToast("所有提示已由 AI 成功生成！請檢查內容。", 'success');
            } catch (error) {
                showToast(`AI 生成所有提示過程中發生錯誤: ${error.message}`, 'error');
                console.error("AI 生成所有提示失敗:", error);
            } finally {
                isGeneratingHintsAI = false;
                generateAllHintsAIButton.disabled = false;
                generateAllHintsAIButton.innerHTML = `<i class="fas fa-robot"></i> AI 生成所有提示`;
                globalAiProgress.classList.remove('active');
                checkAllCompletionStates();
            }
        }
        if (generateAllHintsAIButton) {
            generateAllHintsAIButton.addEventListener('click', generateAllHintsAIHandler);
        }


        function generatePart3Forms() {
            if (keyphrases.length === 0) {
                answersAndHintsFormsContainer.innerHTML = '<p style="color:var(--ui-error-red);">請先在 Part 2 定義關鍵詞。</p>';
                proceedToPart4Btn.disabled = true;
                if (generateAllHintsAIButton) generateAllHintsAIButton.disabled = true;
                if (globalAiProgress) globalAiProgress.classList.remove('active');
                checkAllCompletionStates();
                return;
            }
            
            answersAndHintsFormsContainer.innerHTML = ''; 

            keyphrases.forEach((kp, index) => {
                const formId = `hints_form_${index}`;
                const existingData = missionData.part3[kp.original] || {};

                const formHtml = `
                    <div class="knowledge-card" id="${formId}">
                        <h3 class="color-${index % KEYWORD_COLORS.length}"><i class="fas fa-key"></i> 關鍵詞 ${index + 1}: ${kp.original}</h3>
                        <div class="form-group">
                            <label><i class="fas fa-bullseye"></i> 1. 目標答案 (Target Answer)</label>
                            <input type="text" value="${kp.original}" class="color-${index % KEYWORD_COLORS.length}" readonly>
                        </div>
                        <div class="form-group">
                            <label for="${formId}_explanation"><i class="fas fa-file-lines"></i> 2. 最終解答說明 (Full Explanation)<span class="required-star">*</span></label>
                            <textarea id="${formId}_explanation" required>${existingData.explanation || ''}</textarea>
                            <div class="word-count" id="${formId}_explanation_counter">0/無限制 字</div>
                        </div>
                        <div class="form-group">
                            <label for="${formId}_hint1"><i class="fas fa-comment-dots"></i> 3. 第一層提示：文字內容 (Most Direct Hint)<span class="required-star">*</span></label>
                            <textarea id="${formId}_hint1" rows="2" required>${existingData.hint1_textContent || ''}</textarea>
                            <div class="word-count" id="${formId}_hint1_counter">0/12 字</div>
                        </div>
                        <div class="form-group">
                            <label for="${formId}_hint2"><i class="fas fa-cube"></i> 4. 第二層提示：正確知識卡鷹架提示 (Background/Contextual Hint)<span class="required-star">*</span></label>
                            <textarea id="${formId}_hint2" rows="2" required>${existingData.hint2_knowledgeCardScaffold || ''}</textarea>
                            <div class="word-count" id="${formId}_hint2_counter">0/25 字</div>
                        </div>
                        <div class="form-group">
                            <label for="${formId}_hint3"><i class="fas fa-sitemap"></i> 5. 第三層提示：整體鷹架提示 (Broadest Scaffolding Hint)<span class="required-star">*</span></label>
                            <textarea id="${formId}_hint3" rows="2" required>${existingData.hint3_overallScaffoldingHint || ''}</textarea>
                            <div class="word-count" id="${formId}_hint3_counter">0/25 字</div>
                        </div>
                        <div class="button-group" style="justify-content: flex-start; margin-top: 0;">
                            <button type="button" class="ai-button" id="${formId}_generate_ai_button" ${currentApiKey ? '' : 'disabled'}>
                                <i class="fas fa-robot"></i> AI 生成提示
                            </button>
                        </div>
                    </div>
                `;
                answersAndHintsFormsContainer.insertAdjacentHTML('beforeend', formHtml);

                setupWordCounter(`${formId}_explanation`, `${formId}_explanation_counter`, -1);
                setupWordCounter(`${formId}_hint1`, `${formId}_hint1_counter`, 12);
                setupWordCounter(`${formId}_hint2`, `${formId}_hint2_counter`, 25);
                setupWordCounter(`${formId}_hint3`, `${formId}_hint3_counter`, 25);
                
                const aiButton = document.getElementById(`${formId}_generate_ai_button`);
                if (aiButton) {
                    aiButton.addEventListener('click', () => generateHintsForSingleKeyphrase(kp, index));
                    aiButton.disabled = !currentApiKey || isGeneratingHintsAI;
                }
            });

            answersAndHintsFormsContainer.addEventListener('input', checkPart3Completion);
            initializeAriaAttributes();
            checkAllCompletionStates();
        }

        function checkPart3Completion() {
            if (keyphrases.length === 0) {
                proceedToPart4Btn.disabled = true;
                if (generateAllHintsAIButton) generateAllHintsAIButton.disabled = true;
                if (globalAiProgress) globalAiProgress.classList.remove('active');
                return false;
            }

            const textareas = document.querySelectorAll('#answersAndHintsForms textarea');
            if (textareas.length !== keyphrases.length * 4) {
                 proceedToPart4Btn.disabled = true;
                 if (generateAllHintsAIButton) generateAllHintsAIButton.disabled = true;
                 if (globalAiProgress) globalAiProgress.classList.remove('active');
                 return false;
            }

            let allFormsFilledAndValid = true;

            Array.from(textareas).forEach(textarea => { 
                const isHint1 = textarea.id.includes('_hint1');
                const isHint2 = textarea.id.includes('_hint2');
                const isHint3 = textarea.id.includes('_hint3');

                let limit = -1;
                if (isHint1) limit = 12;
                else if (isHint2 || isHint3) limit = 25;
                
                const isFilled = textarea.value.trim().length > 0;
                const withinLimit = (limit === -1 || textarea.value.length <= limit);

                const counterId = textarea.id + '_counter';
                const counter = document.getElementById(counterId);

                if (!isFilled || !withinLimit) {
                    allFormsFilledAndValid = false;
                    textarea.style.borderColor = 'var(--ui-error-red)';
                    if (counter) counter.style.color = 'var(--ui-error-red)';
                } else {
                    textarea.style.borderColor = 'var(--border-light)';
                    if (counter) counter.style.color = 'var(--text-medium)';
                }
            });
            
            proceedToPart4Btn.disabled = !allFormsFilledAndValid;
            if (generateAllHintsAIButton) {
                generateAllHintsAIButton.disabled = isGeneratingHintsAI || !currentApiKey;
            }
            if (globalAiProgress) globalAiProgress.classList.toggle('active', isGeneratingHintsAI);
            
            keyphrases.forEach((kp, index) => {
                const aiButton = document.getElementById(`hints_form_${index}_generate_ai_button`);
                if (aiButton) {
                    aiButton.disabled = isGeneratingHintsAI || !currentApiKey;
                }
            });

            return allFormsFilledAndValid;
        }

        document.getElementById('proceedToPart4').addEventListener('click', () => {
            if (!checkPart3Completion()) {
                showToast('請填寫 Part 3 的所有必填欄位，並確保文字內容符合字數限制！請檢查紅色的輸入框。', 'error');
                return;
            }
            missionData.part3 = getPart3DataFromDOM();

            goToPart(4);
        });


        // =========================================================
        // Part 4: 建立知識卡組 (Crafting Knowledge Card Sets)
        // =========================================================
        const knowledgeCardSetsContainer = document.getElementById('knowledgeCardSets');
        const proceedToPart5Btn = document.getElementById('proceedToPart5');

        let isGeneratingIncorrectCardsAI = false; 

        function getAvailableSubjectsForCards() {
            const subjects = new Set();
            if (missionData.part1 && missionData.part1.mainSubject) {
                subjects.add(missionData.part1.mainSubject);
            }
            if (missionData.part1 && missionData.part1.otherSubjects) {
                missionData.part1.otherSubjects.forEach(sub => subjects.add(sub));
            }
            const filteredSubjects = Array.from(subjects).filter(s => s && s.trim() !== '');
            return filteredSubjects.sort();
        }

        function getPart4DataFromDOM() {
            const currentPart4Data = {};
            keyphrases.forEach((kp, index) => {
                const currentPart4KeyData = {};
                const correctCardPrefix = `correct_card_${index}`;
                
                const correctCardSubjectSelect = document.getElementById(`${correctCardPrefix}_subject`); 
                const correctCardCategorySelect = document.getElementById(`${correctCardPrefix}_category`);
                const correctCardImageFile = document.getElementById(`${correctCardPrefix}_image_file`);
                const correctCardImageUrl = document.getElementById(`${correctCardPrefix}_image_url`);
                const correctCardExternalInfo = document.getElementById(`${correctCardPrefix}_externalInfo`);
                const correctCardTextContent = document.getElementById(`${correctCardPrefix}_textcontent`);

                currentPart4KeyData.correctCard = {
                    cardName: kp.original,
                    imageUrl: correctCardImageUrl?.value || (correctCardImageFile?.files && correctCardImageFile.files[0] ? `files/${correctCardImageFile.files[0].name}` : ''),
                    subject: correctCardSubjectSelect?.value || '',
                    category: correctCardCategorySelect?.value || '',
                    textContent: correctCardTextContent?.value || '',
                    externalInfo: correctCardExternalInfo?.value || '',
                    clueDescription: kp.category,
                    scaffoldingHint: missionData.part3[kp.original]?.hint2_knowledgeCardScaffold || ''
                };

                currentPart4KeyData.incorrectCards = [];
                const incorrectCardsContainer = document.getElementById(`incorrect_cards_${index}_container`);
                if (incorrectCardsContainer) {
                    const incorrectCardElements = incorrectCardsContainer.querySelectorAll('.incorrect-card-item');
                    incorrectCardElements.forEach((cardElem, cardIdx) => {
                        const cardId = cardElem.id;
                        const incorrectCardNameInput = document.getElementById(`${cardId}_name`);
                        const incorrectCardImageFile = document.getElementById(`${cardId}_image_file`);
                        const incorrectCardImageUrl = document.getElementById(`${cardId}_image_url`);
                        const incorrectCardSubjectSelect = document.getElementById(`${cardId}_subject`); 
                        const incorrectCardCategorySelect = document.getElementById(`${cardId}_category`);
                        const incorrectCardTextContent = document.getElementById(`${cardId}_textcontent`);
                        const incorrectCardExternalInfo = document.getElementById(`${cardId}_externalInfo`);

                        currentPart4KeyData.incorrectCards.push({
                            cardName: incorrectCardNameInput?.value || '',
                            imageUrl: incorrectCardImageUrl?.value || (incorrectCardImageFile?.files && incorrectCardImageFile.files[0] ? `files/${incorrectCardImageFile.files[0].name}` : ''),
                            subject: incorrectCardSubjectSelect?.value || '', 
                            category: incorrectCardCategorySelect?.value || '',
                            textContent: incorrectCardTextContent?.value || '',
                            externalInfo: incorrectCardExternalInfo?.value || '',
                            clueDescription: kp.category
                        });
                    });
                }
                currentPart4Data[kp.original] = currentPart4KeyData;
            });
            return currentPart4Data;
        }

        async function generateSingleIncorrectCardTextContentAI(keyphraseOriginal, keyphraseCategory, incorrectCardName, keyphraseIndex, cardIndex) {
            const cardId = `incorrect_card_${keyphraseIndex}_${cardIndex}`;
            const textContentInput = document.getElementById(`${cardId}_textcontent`);
            const aiButton = document.getElementById(`${cardId}_generate_text_ai_button`);
            const incorrectCardWrapper = document.getElementById(cardId);
        
            if (!textContentInput || !aiButton || !incorrectCardWrapper) {
                 console.warn(`Missing DOM elements for incorrect card ${cardId}. Skipping AI generation.`);
                 return;
            }
            if (!incorrectCardName.trim()) {
                showToast("請先為錯誤卡片填寫名稱，AI 才能生成內容。", 'info');
                return;
            }

            const originalButtonIcon = aiButton.innerHTML;
            aiButton.disabled = true;
            aiButton.innerHTML = `<span class="loading-spinner inline-small"></span>`;
            showAIOverlay(incorrectCardWrapper, `AI 正在生成「${incorrectCardName}」的文字內容...`);
        
            try {
                const subject = missionData.part1.mainSubject; 
        
                // --- MODIFIED AI PROMPT ---
                // Focus ONLY on defining the incorrect card name itself.
                // Removed references to "correct concept" in the instruction part to avoid misleading definitions.
                const prompt = `請為以下錯誤知識卡名稱生成一個精簡的「文字內容定義」：
錯誤卡片名稱: ${incorrectCardName}
所屬學科: ${subject}

請提供一個繁體中文的「文字內容定義」(\`textContent\`)，長度限制在12字以內。
這個定義必須是針對「${incorrectCardName}」這個錯誤卡片名稱本身的**客觀定義或簡要描述**。

範例 1 (如果錯誤卡片名稱是「北韓」):
理想的錯誤定義應該是：位於東亞的共產國家。

範例 2 (如果錯誤卡片名稱是「龍」):
理想的錯誤定義應該是：會飛，噴火，神話中的生物。
        
請以 JSON 格式回傳，例如：
{\n  "textContent": "某錯誤定義"\n}`;
                // --- END MODIFIED AI PROMPT ---
        
                const payload = {
                    contents: [{ parts: [{ text: prompt }] }],
                    generationConfig: {
                        responseMimeType: "application/json"
                    },
                    safetySettings: [
                        { category: "HARM_CATEGORY_HATE_SPEECH", threshold: "BLOCK_NONE" },
                        { category: "HARM_CATEGORY_SEXUALLY_EXPLICIT", threshold: "BLOCK_NONE" },
                        { category: "HARM_CATEGORY_DANGEROUS_CONTENT", threshold: "BLOCK_NONE" },
                        { category: "HARM_CATEGORY_HARASSMENT", threshold: "BLOCK_NONE" }
                    ]
                };
        
                const result = await fetchWithGeminiRetry(GEMINI_API_URL_TEXT, payload);
                const jsonText = result.candidates?.[0]?.content?.parts?.[0]?.text;

                if (jsonText) {
                    const data = JSON.parse(jsonText);
                    textContentInput.value = data.textContent || '';
                    textContentInput.dispatchEvent(new Event('input')); // Trigger word counter
                    showToast(`錯誤卡「${incorrectCardName}」的文字內容已生成。`, 'success');
                } else {
                    throw new Error("AI 未返回有效的 JSON 格式內容。");
                }
            } catch (error) {
                showToast(`AI 生成錯誤卡「${incorrectCardName}」的文字內容失敗: ${error.message}`, 'error');
                console.error(`AI 生成錯誤卡「${incorrectCardName}」的文字內容失敗:`, error);
            } finally {
                aiButton.disabled = false;
                aiButton.innerHTML = originalButtonIcon;
                hideAIOverlay(incorrectCardWrapper);
                checkAllCompletionStates();
            }
        }


        function generatePart4Forms() {
            if (keyphrases.length === 0) {
                knowledgeCardSetsContainer.innerHTML = '<p style="color:var(--ui-error-red);">請先在 Part 2 定義關鍵詞。</p>';
                checkAllCompletionStates();
                return;
            }

            knowledgeCardSetsContainer.innerHTML = ''; 
            const availableSubjects = getAvailableSubjectsForCards();

            const categoryOptions = `
                <option value="">請選擇</option>
                <option value="事件卡">事件卡</option>
                <option value="人物卡">人物卡</option>
                <option value="時間卡">時間卡</option>
                <option value="地點卡">地點卡</option>
                <option value="物件卡">物件卡</option>
                <option value="語文卡">語文卡</option>
                <option value="數字卡">數字卡</option>
                <option value="符號卡">符號卡</option>
                <option value="概念卡">概念卡</option>
                <option value="現象卡">現象卡</option>
            `;

            // Loop through ALL keyphrases to generate a card set for each
            keyphrases.forEach((kp, index) => {
                const correctCardDefinition = missionData.part3[kp.original]?.hint1_textContent || '';
                const correctCardScaffoldingHint = missionData.part3[kp.original]?.hint2_knowledgeCardScaffold || '';

                // Ensure missionData.part4[kp.original] is initialized if not present
                missionData.part4[kp.original] = missionData.part4[kp.original] || { correctCard: {}, incorrectCards: [] };
                
                const existingCorrectCard = missionData.part4[kp.original].correctCard || {};
                const existingIncorrectCards = missionData.part4[kp.original].incorrectCards || [];

                const cardSetHtml = `
                    <div class="card-set-for-keyphrase">
                        <h3 class="color-${index % KEYWORD_COLORS.length}"><i class="fas fa-puzzle-piece"></i> 關鍵詞 ${index + 1}: ${kp.original} 的知識卡組</h3>
                        <div class="knowledge-card correct">
                            <h4><i class="fas fa-check-circle"></i> 正確知識卡: ${kp.original}</h4>
                            <div class="form-group">
                                <label><i class="fas fa-signature"></i> 卡片名稱:</label>
                                <input type="text" value="${kp.original}" class="color-${index % KEYWORD_COLORS.length}" readonly>
                            </div>
                            <div class="form-group">
                                <label for="correct_card_${index}_subject"><i class="fas fa-book"></i> 學科:<span class="required-star">*</span></label>
                                <select id="correct_card_${index}_subject" required>
                                    <option value="">請選擇</option>
                                    ${availableSubjects.map(sub => `<option value="${sub}" ${existingCorrectCard.subject === sub ? 'selected' : ''}>${sub}</option>`).join('')}
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="correct_card_${index}_image_file"><i class="fas fa-image"></i> 圖片 (檔案上傳): （以無版權問題的圖或歷史照片為主，部份卡片不需要附圖）</label>
                                <input type="file" id="correct_card_${index}_image_file" accept="image/*">
                                <label for="correct_card_${index}_image_url"><i class="fas fa-link"></i> 或 圖片 (URL):</label>
                                <input type="url" id="correct_card_${index}_image_url" placeholder="輸入圖片 URL" value="${existingCorrectCard.imageUrl && !existingCorrectCard.imageUrl.startsWith('files/') ? existingCorrectCard.imageUrl : ''}">
                                <img id="correct_card_${index}_image_preview" class="image-preview" src="${existingCorrectCard.imageUrl || ''}" style="display: ${existingCorrectCard.imageUrl ? 'block' : 'none'};">
                            </div>
                            <div class="form-group">
                                <label for="correct_card_${index}_category"><i class="fas fa-folder-open"></i> 類別:<span class="required-star">*</span></label>
                                <select id="correct_card_${index}_category" required>
                                    ${categoryOptions.replace(`value="${existingCorrectCard.category}"`, `value="${existingCorrectCard.category}" selected`)}
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="correct_card_${index}_textcontent"><i class="fas fa-pen-to-square"></i> 文字內容 (定義):<span class="required-star">*</span></label>
                                <textarea id="correct_card_${index}_textcontent" rows="2" required readonly>${correctCardDefinition}</textarea>
                                <div class="word-count" id="correct_card_${index}_textcontent_counter">0/12 字</div>
                            </div>
                            <div class="form-group">
                                <label for="correct_card_${index}_externalInfo"><i class="fas fa-external-link-alt"></i> 因材網或外部資訊 (URL): （可加、可不加）</label>
                                <input type="url" id="correct_card_${index}_externalInfo" value="${existingCorrectCard.externalInfo || ''}">
                            </div>
                            <div class="form-group">
                                <label><i class="fas fa-info-circle"></i> 卡片線索說明 (與題幹關鍵詞變數相同):</label>
                                <input type="text" value="${kp.category}" readonly>
                            </div>
                            <div class="form-group">
                                <label><i class="fas fa-network-wired"></i> 正確知識卡鷹架提示 (來自 Part 3):</label>
                                <textarea readonly>${correctCardScaffoldingHint}</textarea>
                            </div>
                        </div>

                        <div class="incorrect-cards-group">
                            <h4><i class="fas fa-times-circle"></i> 錯誤知識卡 (3張)</h4>
                            <p>請為每個關鍵詞設計三張具有迷惑性，但與正確答案相關的錯誤知識卡。</p>
                            <div id="incorrect_cards_${index}_container">
                                <!-- 錯誤知識卡將動態添加於此 -->
                            </div>
                        </div>
                    </div>
                `;
                knowledgeCardSetsContainer.insertAdjacentHTML('beforeend', cardSetHtml);

                setupImagePreview(`correct_card_${index}_image_file`, `correct_card_${index}_image_preview`, `correct_card_${index}_image_url`);
                setupWordCounter(`correct_card_${index}_textcontent`, `correct_card_${index}_textcontent_counter`, 12);
                
                for (let i = 0; i < 3; i++) {
                    addIncorrectCard(kp.original, index, i, existingIncorrectCards[i] || {}, categoryOptions);
                }
            });

            knowledgeCardSetsContainer.addEventListener('input', checkPart4Completion);
            knowledgeCardSetsContainer.addEventListener('change', checkPart4Completion);
            initializeAriaAttributes();
            checkAllCompletionStates();
        }

        function addIncorrectCard(originalKeyphrase, keyphraseIndex, cardIndex, cardData = {}, categoryOptionsHtml) {
            const container = document.getElementById(`incorrect_cards_${keyphraseIndex}_container`);
            const cardId = `incorrect_card_${keyphraseIndex}_${cardIndex}`;
            const availableSubjects = getAvailableSubjectsForCards();

            // Safely get cardData properties, defaulting to empty string if undefined
            const cardNameValue = cardData.cardName || '';
            const cardSubjectValue = cardData.subject || '';
            const cardCategoryValue = cardData.category || '';
            const cardTextContentValue = cardData.textContent || '';
            const cardExternalInfoValue = cardData.externalInfo || '';
            const cardImageUrlValue = cardData.imageUrl || '';


            const cardHtml = `
                <div class="incorrect-card-item" id="${cardId}">
                    <h5><i class="fas fa-exclamation-triangle"></i> 錯誤卡 ${cardIndex + 1}</h5>
                    <div class="form-group">
                        <label for="${cardId}_name"><i class="fas fa-signature"></i> 卡片名稱:<span class="required-star">*</span></label>
                        <input type="text" id="${cardId}_name" value="${cardNameValue}" class="color-${keyphraseIndex % KEYWORD_COLORS.length}" required>
                    </div>
                    <div class="form-group">
                        <label for="${cardId}_subject"><i class="fas fa-book"></i> 學科:<span class="required-star">*</span></label>
                        <select id="${cardId}_subject" required>
                            <option value="">請選擇</option>
                            ${availableSubjects.map(sub => `<option value="${sub}" ${cardSubjectValue === sub ? 'selected' : ''}>${sub}</option>`).join('')}
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="${cardId}_category"><i class="fas fa-folder-open"></i> 類別:<span class="required-star">*</span></label>
                        <select id="${cardId}_category" required>
                            ${categoryOptionsHtml.replace(`value="${cardCategoryValue}"`, `value="${cardCategoryValue}" selected`)}
                        </select>
                    </div>
                    <div class="form-group">
                        <div class="label-with-ai-button">
                            <!-- 新增圖示到文字內容定義標籤 -->
                            <label for="${cardId}_textcontent"><i class="fas fa-file-lines"></i> 文字內容 (定義):<span class="required-star">*</span></label>
                            <button type="button" class="ai-button inline-small" id="${cardId}_generate_text_ai_button" ${!currentApiKey || !cardNameValue.trim() ? 'disabled' : ''}>
                                <i class="fas fa-wand-magic-sparkles"></i>
                            </button>
                        </div>
                        <textarea id="${cardId}_textcontent" rows="2" required>${cardTextContentValue}</textarea>
                        <div class="word-count" id="${cardId}_textcontent_counter">0/12 字</div>
                    </div>
                    <details>
                        <summary><i class="fas fa-caret-right"></i> 圖片與外部資訊</summary>
                        <p style="font-size: 0.85em; color: var(--text-medium); margin-top: 10px;">（可加、可不加）</p>
                        <div class="form-group">
                            <label for="${cardId}_image_file"><i class="fas fa-image"></i> 圖片 (檔案上傳):</label>
                            <input type="file" id="${cardId}_image_file" accept="image/*">
                            <label for="${cardId}_image_url"><i class="fas fa-link"></i> 或 圖片 (URL):</label>
                            <input type="url" id="${cardId}_image_url" placeholder="輸入圖片 URL" value="${cardImageUrlValue && !cardImageUrlValue.startsWith('files/') ? cardImageUrlValue : ''}">
                            <img id="${cardId}_image_preview" class="image-preview" src="${cardImageUrlValue || ''}" style="display: ${cardImageUrlValue ? 'block' : 'none'};">
                        </div>
                        <div class="form-group">
                            <label for="${cardId}_externalInfo"><i class="fas fa-external-link-alt"></i> 因材網或外部資訊 (URL):</label>
                            <input type="url" id="${cardId}_externalInfo" value="${cardExternalInfoValue}">
                        </div>
                    </details>
                </div>
            `;
            container.insertAdjacentHTML('beforeend', cardHtml);

            setupImagePreview(`${cardId}_image_file`, `${cardId}_image_preview`, `${cardId}_image_url`);
            setupWordCounter(`${cardId}_textcontent`, `${cardId}_textcontent_counter`, 12);
            
            const individualAiButton = document.getElementById(`${cardId}_generate_text_ai_button`);
            const cardNameInput = document.getElementById(`${cardId}_name`);

            const updateIndividualAiButtonState = () => {
                if (individualAiButton && cardNameInput) {
                    individualAiButton.disabled = isGeneratingIncorrectCardsAI || !currentApiKey || !cardNameInput.value.trim();
                }
            };
            
            if (individualAiButton && cardNameInput) {
                cardNameInput.addEventListener('input', updateIndividualAiButtonState);
                individualAiButton.addEventListener('click', () => {
                    generateSingleIncorrectCardTextContentAI(originalKeyphrase, keyphrases.find(k => k.original === originalKeyphrase).category, cardNameInput.value.trim(), keyphraseIndex, cardIndex);
                });
                updateIndividualAiButtonState();
            }
            checkAllCompletionStates();
        }


        function checkPart4Completion() {
            let allFilled = true;
            let correctCardCount = 0;
            let totalCardCount = 0;

            if (keyphrases.length === 0) {
                allFilled = false;
                proceedToPart5Btn.disabled = true;
                return false;
            }

            keyphrases.forEach((kp, index) => {
                // Check Correct Knowledge Card
                const correctCardTextContentInput = document.getElementById(`correct_card_${index}_textcontent`);
                const correctCardSubjectSelect = document.getElementById(`correct_card_${index}_subject`); 
                const correctCardCategorySelect = document.getElementById(`correct_card_${index}_category`);

                const correctTextValid = correctCardTextContentInput && correctCardTextContentInput.value.trim().length > 0 && correctCardTextContentInput.value.length <= 12;
                const correctSubjectValid = correctCardSubjectSelect && correctCardSubjectSelect.value !== ""; 
                const correctCategoryValid = correctCardCategorySelect && correctCardCategorySelect.value !== "";

                if (!correctTextValid) {
                    if (correctCardTextContentInput) correctCardTextContentInput.style.borderColor = 'var(--ui-error-red)';
                    const counter = document.getElementById(`correct_card_${index}_textcontent_counter`);
                    if (counter) counter.style.color = 'var(--ui-error-red)';
                    allFilled = false;
                } else {
                    if (correctCardTextContentInput) correctCardTextContentInput.style.borderColor = 'var(--border-light)';
                    const counter = document.getElementById(`correct_card_${index}_textcontent_counter`);
                    if (counter) counter.style.color = 'var(--text-medium)';
                }
                if (!correctSubjectValid) { 
                    if (correctCardSubjectSelect) correctCardSubjectSelect.style.borderColor = 'var(--ui-error-red)';
                    allFilled = false;
                } else {
                     if (correctCardSubjectSelect) correctCardSubjectSelect.style.borderColor = 'var(--border-light)';
                }
                if (!correctCategoryValid) {
                    if (correctCardCategorySelect) correctCardCategorySelect.style.borderColor = 'var(--ui-error-red)';
                    allFilled = false;
                } else {
                     if (correctCardCategorySelect) correctCardCategorySelect.style.borderColor = 'var(--border-light)';
                }

                if (correctTextValid && correctSubjectValid && correctCategoryValid) {
                    correctCardCount++;
                    totalCardCount++;
                } else {
                    allFilled = false;
                }


                // Check Incorrect Knowledge Cards (exactly 3 and all filled)
                const incorrectCardsContainer = document.getElementById(`incorrect_cards_${index}_container`);
                const incorrectCardElements = incorrectCardsContainer ? incorrectCardsContainer.querySelectorAll('.incorrect-card-item') : [];
                
                if (incorrectCardElements.length !== 3) {
                    allFilled = false;
                }

                incorrectCardElements.forEach((cardElem, cardIdx) => {
                    const cardId = cardElem.id;
                    const nameInput = document.getElementById(`${cardId}_name`);
                    const textContentInput = document.getElementById(`${cardId}_textcontent`);
                    const subjectSelect = document.getElementById(`${cardId}_subject`); 
                    const categorySelect = document.getElementById(`${cardId}_category`);
                    const individualAiButton = document.getElementById(`${cardId}_generate_text_ai_button`);


                    const nameValid = nameInput && nameInput.value.trim().length > 0;
                    const textContentValid = textContentInput && textContentInput.value.trim().length > 0 && textContentInput.value.length <= 12;
                    const subjectValid = subjectSelect && subjectSelect.value !== ""; 
                    const categoryValid = categorySelect && categorySelect.value !== "";

                    if (!nameValid) {
                        if (nameInput) nameInput.style.borderColor = 'var(--ui-error-red)';
                        allFilled = false;
                    } else {
                        if (nameInput) nameInput.style.borderColor = 'var(--border-light)';
                    }

                    if (!textContentValid) {
                        if (textContentInput) textContentInput.style.borderColor = 'var(--ui-error-red)';
                        const counter = document.getElementById(`${cardId}_textcontent_counter`);
                        if (counter) counter.style.color = 'var(--ui-error-red)';
                        allFilled = false;
                    } else {
                        if (textContentInput) textContentInput.style.borderColor = 'var(--border-light)';
                        const counter = document.getElementById(`${cardId}_textcontent_counter`);
                        if (counter) counter.style.color = 'var(--text-medium)';
                    }
                    
                    if (!subjectValid) { 
                        if (subjectSelect) subjectSelect.style.borderColor = 'var(--ui-error-red)';
                        allFilled = false;
                    } else {
                        if (subjectSelect) subjectSelect.style.borderColor = 'var(--border-light)';
                    }

                    if (!categoryValid) {
                        if (categorySelect) categorySelect.style.borderColor = 'var(--ui-error-red)';
                        allFilled = false;
                    } else {
                        if (categorySelect) categorySelect.style.borderColor = 'var(--border-light)';
                    }

                    totalCardCount++;

                    // Update individual AI button state (disabled if global AI is running, no API key, or card name is empty)
                    if (individualAiButton && nameInput) {
                        individualAiButton.disabled = isGeneratingIncorrectCardsAI || !currentApiKey || !nameInput.value.trim();
                    }
                });
            });

            proceedToPart5Btn.disabled = !allFilled;
            
            document.getElementById('totalKnowledgeCards').textContent = totalCardCount;
            document.getElementById('correctKnowledgeCards').textContent = correctCardCount;
            return allFilled;
        }

        document.getElementById('proceedToPart5').addEventListener('click', () => {
            if (!checkPart4Completion()) {
                showToast('請確保所有正確知識卡和剛好三張錯誤知識卡都已填寫完成，且文字內容符合字數限制！請檢查紅色的輸入框。', 'error');
                return;
            }
            missionData.part4 = getPart4DataFromDOM();

            goToPart(5);
            checkPart4Completion(); // Update total card count for Part 5 summary
        });

        // 匯出數據
        document.getElementById('exportData').addEventListener('click', () => {
            // Ensure all data is collected into missionData
            collectPart1Data();
            collectPart2Data();
            missionData.part3 = getPart3DataFromDOM();
            missionData.part4 = getPart4DataFromDOM();

            const dataStr = JSON.stringify(missionData, null, 2);
            document.getElementById('fullDataSummary').textContent = dataStr;

            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `時空學園命題_${missionData.part1?.missionTitle || '未命名'}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showToast('JSON 檔案已匯出！', 'success');
        });

        // =========================================================
        // JSON 匯入功能
        // 針對每個 Part 設置事件監聽
        // =========================================================
        const importJsonFiles = {};
        const importJsonBtns = {};
        const exportJsonBtns = {};

        for (let i = 1; i <= 5; i++) {
            importJsonFiles[`Part${i}`] = document.getElementById(`importJsonFile_Part${i}`);
            importJsonBtns[`Part${i}`] = document.getElementById(`importJsonBtn_Part${i}`);
            exportJsonBtns[`Part${i}`] = document.getElementById(`exportJsonBtn_Part${i}`);

            if (importJsonBtns[`Part${i}`]) {
                importJsonBtns[`Part${i}`].addEventListener('click', () => {
                    const fileInput = importJsonFiles[`Part${i}`];
                    if (fileInput.files.length === 0) {
                        showToast('請選擇一個 JSON 檔案。', 'error');
                        return;
                    }

                    const file = fileInput.files[0];
                    const reader = new FileReader();

                    reader.onload = (e) => {
                        try {
                            const importedData = JSON.parse(e.target.result);
                            populateFormsFromJson(importedData);
                            showToast('JSON 數據已成功載入！', 'success');
                        } catch (error) {
                            showToast('載入 JSON 檔案失敗，請檢查檔案格式是否正確。', 'error');
                            console.error('Error parsing JSON:', error);
                        }
                    };

                    reader.onerror = (error) => {
                        showToast('讀取檔案失敗。', 'error');
                        console.error('Error reading file:', error);
                    };

                    reader.readAsText(file);
                });
            }

            if (exportJsonBtns[`Part${i}`]) {
                exportJsonBtns[`Part${i}`].addEventListener('click', () => {
                    // Ensure all data is collected
                    collectPart1Data();
                    collectPart2Data();
                    missionData.part3 = getPart3DataFromDOM();
                    missionData.part4 = getPart4DataFromDOM();

                    const dataStr = JSON.stringify(missionData, null, 2);
                    const filename = `時空學園命題_${missionData.part1?.missionTitle || '未命名'}.json`;
                    
                    const blob = new Blob([dataStr], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = filename;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    showToast('JSON 檔案已匯出！', 'success');
                });
            }
        }


        function populateFormsFromJson(data) {
            // Clear existing data and state
            keyphrases = [];
            missionData.part1 = {};
            missionData.part2 = {};
            missionData.part3 = {};
            missionData.part4 = {};

            // Populate Part 1
            if (data.part1) {
                Object.assign(missionData.part1, data.part1); // Ensure missionData.part1 is fully populated first

                missionTitleInput.value = missionData.part1.missionTitle || '';
                
                const loadedMainSubject = missionData.part1.mainSubject;
                if (ALL_SUBJECTS.includes(loadedMainSubject)) {
                    mainSubjectSelect.value = loadedMainSubject;
                    customMainSubjectInputGroup.style.display = 'none';
                    customMainSubjectInput.value = '';
                } else {
                    mainSubjectSelect.value = '其他';
                    customMainSubjectInputGroup.style.display = 'flex';
                    customMainSubjectInput.value = loadedMainSubject;
                }
                mainSubjectSelect.dispatchEvent(new Event('change')); // Trigger change to re-generate other subjects

                document.getElementById('curriculumGuidelines').value = missionData.part1.curriculumGuidelines || '';
                document.getElementById('gradeLevel').value = missionData.part1.gradeLevel || '';
                document.getElementById('semesterLevel').value = missionData.part1.semesterLevel || '';
                document.getElementById('location').value = missionData.part1.location || '';
                document.getElementById('century').value = missionData.part1.century || '';
            }

            // Populate Part 2
            if (data.part2) {
                originalTextarea.value = data.part2.originalText || '';
                if (data.part2.keyphrases) {
                    keyphrases = data.part2.keyphrases.map((kp, idx) => ({
                        original: kp.original,
                        category: kp.category,
                        color: KEYWORD_COLORS[idx % KEYWORD_COLORS.length] // Re-assign colors based on current theme
                    }));
                    keyphrasesTextarea.value = keyphrases.map(kp => kp.original).join('\n');
                    generateKeyphraseCategoriesBtn.click(); // Manually trigger generation for keyphrase categories

                    setTimeout(() => { // Wait for the table to generate before populating categories
                        keyphrases.forEach((kp, idx) => {
                            const inputElem = document.getElementById(`keyphrase_category_input_${idx}`);
                            if (inputElem) {
                                inputElem.value = kp.category;
                                inputElem.style.color = kp.color; // Set text color for loaded data
                            }
                        });
                        generateClueTextBtn.click(); // Manually trigger clue text generation
                    }, 150); // Slightly longer delay
                }
                Object.assign(missionData.part2, data.part2);
            }

            // Part 3 and Part 4 data are stored directly in missionData for subsequent generateForms calls
            if (data.part3) Object.assign(missionData.part3, data.part3);
            if (data.part4) Object.assign(missionData.part4, data.part4);
            
            checkAllCompletionStates();
            goToPart(1); // Navigate back to Part 1 after loading
        }

        // =========================================================
        // Word 匯出功能
        // =========================================================
        document.getElementById('exportWord').addEventListener('click', () => {
            // Ensure all data is collected into missionData
            collectPart1Data();
            collectPart2Data();
            missionData.part3 = getPart3DataFromDOM();
            missionData.part4 = getPart4DataFromDOM();

            const docContent = formatDataForWord(missionData);
            const filename = `時空學園命題_${missionData.part1?.missionTitle || '未命名'}.doc`;
            
            const blob = new Blob([docContent], { type: 'application/msword;charset=utf-8' });
            saveAs(blob, filename); // Uses FileSaver.js
            showToast('Word 檔案已匯出！', 'success');
        });

        function formatDataForWord(data) {
            let content = '';

            content += '===================================================\r\n';
            content += `時空學園命題設計引導系統\r\n`;
            content += '===================================================\r\n\r\n';

            // Part 1
            content += '--- Part 1: 基礎任務設定 ---\r\n';
            if (data.part1) {
                content += `任務名稱: ${data.part1.missionTitle || '未填寫'}\r\n`;
                content += `主要學科: ${data.part1.mainSubject || '未選擇'}\r\n`;
                content += `其他學科: ${(data.part1.otherSubjects || []).join(', ') || '無'}\r\n`;
                content += `課綱: ${data.part1.curriculumGuidelines || '未填寫'}\r\n`;
                content += `等級: ${data.part1.gradeLevel || '未選擇'}${data.part1.semesterLevel || '未選擇'}\r\n`;
                content += `地點: ${data.part1.location || '未填寫'}\r\n`;
                content += `世紀: ${data.part1.century || '未填寫'}\r\n`;
            }
            content += '\r\n';

            // Part 2
            content += '--- Part 2: 線索文本轉換 ---\r\n';
            if (data.part2) {
                content += `原始線索文本:\r\n${data.part2.originalText || '無'}\r\n\r\n`;
                // Remove HTML tags for plain text display in Word
                content += `線索文本 (後臺預覽): (使用 $[] 符號標記隱藏關鍵詞)\r\n${data.part2.clueTextHtml?.replace(/<[^>]*>?/gm, '') || '無'}\r\n\r\n`;
                content += `關鍵詞定義:\r\n`;
                (data.part2.keyphrases || []).forEach(kp => {
                    content += `- ${kp.original} -> $[[${kp.category}]]\r\n`;
                });
            }
            content += '\r\n';

            // Part 3
            content += '--- Part 3: 設計答案與提示系統 ---\r\n';
            if (data.part3 && Object.keys(data.part3).length > 0) {
                for (const keyphrase in data.part3) {
                    const item = data.part3[keyphrase];
                    content += `\r\n關鍵詞: ${keyphrase}\r\n`;
                    content += `  最終解答說明: ${item.explanation || '未填寫'}\r\n`;
                    content += `  第一層提示 (文字內容): ${item.hint1_textContent || '未填寫'}\r\n`;
                    content += `  第二層提示 (正確知識卡鷹架提示): ${item.hint2_knowledgeCardScaffold || '未填寫'}\r\n`;
                    content += `  第三層提示 (整體鷹架提示): ${item.hint3_overallScaffoldingHint || '未填寫'}\r\n`;
                }
            } else {
                content += '無 Part 3 數據。\r\n';
            }
            content += '\r\n';

            // Part 4
            content += '--- Part 4: 建立知識卡組 ---\r\n';
            if (data.part4 && Object.keys(data.part4).length > 0) {
                for (const keyphrase in data.part4) {
                    const cardSet = data.part4[keyphrase];
                    content += `\r\n**關鍵詞: ${keyphrase} 的知識卡組**\r\n`;

                    // Correct Card
                    content += `  **A. 正確知識卡: ${cardSet.correctCard?.cardName || '無'}**\r\n`;
                    content += `    卡片名稱: ${cardSet.correctCard?.cardName || '無'}\r\n`; 
                    content += `    學科: ${cardSet.correctCard?.subject || '未選擇'}\r\n`;
                    content += `    圖片URL: ${cardSet.correctCard?.imageUrl || '無'}\r\n`;
                    content += `    類別: ${cardSet.correctCard?.category || '未選擇'}\r\n`;
                    content += `    文字內容 (定義): ${cardSet.correctCard?.textContent || '未填寫'}\r\n`;
                    content += `    外部資訊: ${cardSet.correctCard?.externalInfo || '無'}\r\n`;
                    content += `    線索說明: ${cardSet.correctCard?.clueDescription || '無'}\r\n`;
                    content += `    鷹架提示: ${cardSet.correctCard?.scaffoldingHint || '無'}\r\n`;

                    // Incorrect Cards
                    content += `  **B. 錯誤知識卡組**\r\n`;
                    if (cardSet.incorrectCards && cardSet.incorrectCards.length > 0) {
                        (cardSet.incorrectCards || []).forEach((incCard, idx) => {
                            content += `    錯誤卡 ${idx + 1}:\r\n`;
                            content += `      卡片名稱: ${incCard.cardName || '無'}\r\n`;
                            content += `      學科: ${incCard.subject || '未選擇'}\r\n`;
                            content += `      圖片URL: ${incCard.imageUrl || '無'}\r\n`;
                            content += `      類別: ${incCard.cardCategory || '未選擇'}\r\n`;
                            content += `      文字內容 (定義): ${incCard.textContent || '未填寫'}\r\n`;
                            content += `      外部資訊: ${incCard.externalInfo || '無'}\r\n`;
                        });
                    } else {
                        content += `    無錯誤卡數據。\r\n`;
                    }
                }
            } else {
                content += '無 Part 4 數據。\r\n';
            }
            content += '\r\n';

            content += '===================================================\r\n';
            content += 'Copyright © Liyuchiutiger Gongminshen\r\n';
            content += '===================================================\r\n';

            return content;
        }

        // Global check for all relevant buttons' disabled state
        function checkAllCompletionStates() {
            checkPart1Completion();
            checkGenerateKeyphraseCategoriesBtn();
            checkGenerateClueTextBtn();
            checkProceedToPart3Btn();
            checkPart3Completion();
            checkPart4Completion();
            // Ensure API key input is disabled if any AI process is running
            if (apiKeyInput) {
                apiKeyInput.disabled = isGeneratingHintsAI || isGeneratingIncorrectCardsAI;
            }
            // Ensure global AI button in Part 3 is disabled if any AI is running or no API key
            if (generateAllHintsAIButton) {
                generateAllHintsAIButton.disabled = isGeneratingHintsAI || !currentApiKey;
            }

            // Ensure individual AI buttons in Part 4 are updated
            // Only re-check if Part 4 is currently visible, to avoid unnecessary DOM queries on hidden elements
            if (document.getElementById('part4').style.display === 'block') { 
                keyphrases.forEach((kp, index) => {
                    for (let i = 0; i < 3; i++) {
                        const cardId = `incorrect_card_${index}_${i}`;
                        const cardNameInput = document.getElementById(`${cardId}_name`);
                        const individualAiButton = document.getElementById(`${cardId}_generate_text_ai_button`);
                        if (individualAiButton && cardNameInput) {
                            individualAiButton.disabled = isGeneratingIncorrectCardsAI || !currentApiKey || !cardNameInput.value.trim();
                        }
                    }
                });
            }
        }

        // =========================================================
        // 頁面初始化
        // =========================================================
        document.addEventListener('DOMContentLoaded', () => {
            // Initialize Particles.js for starry background with a slight delay
            // to ensure Font Awesome font is fully loaded.
            setTimeout(() => {
                tsParticles.load("tsparticles", {
                    fpsLimit: 60,
                    // Add background configuration directly to tsparticles
                    background: {
                        color: {
                            value: "#090A0F", // Fallback dark color for the particles canvas
                        },
                        image: "radial-gradient(ellipse at bottom, #1B2735 0%, #090A0F 100%)", // Use this gradient as background
                        repeat: "no-repeat",
                        size: "cover",
                        position: "50% 50%",
                        opacity: 1 // Ensure gradient is fully opaque
                    },
                    interactivity: {
                        events: {
                            onHover: {
                                enable: true,
                                mode: "grab", // Allow grabbing particles
                                parallax: {
                                    enable: true,
                                    force: 60,
                                    smooth: 10
                                }
                            },
                            onClick: {
                                enable: false, // Particles no longer burst on general click
                            },
                            resize: true,
                        },
                        modes: {
                            grab: {
                                distance: 150,
                                links: {
                                    opacity: 0.4
                                }
                            },
                            bubble: { // Still available if needed for other hover effects
                                distance: 200,
                                size: 8,
                                duration: 2,
                                opacity: 0.8,
                                color: {
                                    value: ["#ffffff", "var(--primary-ui-blue)"]
                                }
                            },
                        },
                    },
                    particles: {
                        color: {
                            // Correctly use the CSS variables for color values
                            value: ["var(--star-color-1)", "var(--star-color-2)", "var(--star-color-3)", "var(--star-color-4)", "var(--star-color-5)", "var(--star-color-6)", "#ffffff", "#cccccc", "#eeeeee"], 
                        },
                        links: {
                            color: "#cccccc", // Links will be light gray
                            distance: 120,
                            enable: true,
                            opacity: 0.1, /* Very subtle links */
                            width: 0.5,
                        },
                        move: {
                            direction: "none",
                            enable: true,
                            outModes: {
                                default: "bounce",
                            },
                            random: true,
                            speed: 0.3, /* Slower movement */
                            straight: false,
                            attract: { enable: false, rotateX: 600, rotateY: 1200 },
                        },
                        number: {
                            density: {
                                enable: true,
                                area: 1000,
                            },
                            value: 80, /* More particles */
                        },
                        opacity: {
                            value: { min: 0.1, max: 0.7 },
                            animation: {
                                enable: true,
                                speed: 0.5,
                                minimumValue: 0.05,
                                sync: false,
                            },
                        },
                        shape: {
                            type: "text", // Change shape type to text
                            options: {
                                text: {
                                    /* Font Awesome unicode icons (Solid style) - ensure Font Awesome 6 is loaded
                                       一些科幻或知識相關的圖標：
                                       \uf005 - 星星 (star)
                                       \uf753 - 彗星 (meteor)
                                       \uf5a0 - 衛星 (satellite-dish)
                                       \uf5d2 - 原子 (atom)
                                       \uf121 - 程式碼 (code)
                                       \uf186 - 月亮 (moon)
                                       \uf02d - 書本 (book)
                                       \uf0ac - 地球 (globe)
                                       \uf10a - 電腦 (desktop)
                                       \uf111 - 圓圈 (circle)
                                       \uf251 - 懷錶 (watch)
                                       \uf0c2 - 雲端 (cloud)
                                       \uf520 - 晶片 (microchip)
                                       \uf135 - 飛機 (plane)
                                    */
                                    value: ["\uf005", "\uf753", "\uf5a0", "\uf5d2", "\uf121", "\uf186", "\uf02d", "\uf0ac", "\uf10a", "\uf111", "\uf251", "\uf0c2", "\uf520", "\uf135"], 
                                    font: "Font Awesome 6 Free", // Specify Font Awesome font family name
                                    weight: "900", // Font weight for Solid icons
                                    style: "normal"
                                }
                            }
                        },
                        size: {
                            value: { min: 12, max: 30 }, // Adjust size for better visibility of symbols
                            animation: {
                                enable: true,
                                speed: 1,
                                minimumValue: 5, // Minimum size for symbols
                                sync: false,
                            },
                        },
                    },
                    detectRetina: true,
                });
            }, 100); // 100ms delay


            goToPart(1); // Default to display Part 1
            
            generateOtherSubjectsCheckboxes(); // Initialize other subject options

            // Ensure customMainSubjectInputGroup initial state is correct
            if (mainSubjectSelect.value === '其他') {
                customMainSubjectInputGroup.style.display = 'flex';
            } else {
                customMainSubjectInputGroup.style.display = 'none';
            }

            setupWordCounter('keyphrasesInput', 'keyphrasesInput_counter', -1); // Initialize Part 2 word counter
            
            checkAllCompletionStates(); // Initial check for all button states including AI buttons
            initializeAriaAttributes(); // Apply ARIA attributes on initial load
        });

        // =========================================================
        // Mascot Interactions (Glow, Shake)
        // Removed particle burst from mascot click
        // =========================================================
        const mascotWrapper = document.getElementById('mascotWrapper');
        mascotWrapper.addEventListener('click', (event) => {
            console.log("Mascot clicked!");
            showToast("靈感一閃！✨", 'info', 2000);
        });


        // =========================================================
        // Help Modal (Draggable and Resizable)
        // Updated event listener for help link
        // =========================================================
        const helpLinkInH1 = document.getElementById('help-link-in-h1');
        const helpModal = document.getElementById('help-modal');
        const closeHelpModalButton = document.getElementById('close-help-modal');
        const helpModalHeader = helpModal.querySelector('.modal-header');

        let isDraggingHelpModal = false;
        let isResizingHelpModal = false;
        let helpModalOffset = { x: 0, y: 0 };
        let initialModalWidth = 0;
        let initialModalHeight = 0;
        let initialMouseX = 0;
        let initialMouseY = 0;
        let currentZIndex = 2100; // Starting z-index for modals, incremented when brought to front

        // Updated event listener
        if (helpLinkInH1) {
            helpLinkInH1.addEventListener('click', (e) => {
                e.preventDefault(); // Prevent default link behavior
                helpModal.style.display = 'block';
                helpModal.style.zIndex = ++currentZIndex; // Bring to front
                
                // Re-center if it's the first time or after a resize
                if (helpModal.style.transform === 'translate(-50%, -50%)' || helpModal.dataset.initialLoad === undefined) {
                    helpModal.style.left = '50%';
                    helpModal.style.top = '50%';
                    helpModal.style.transform = 'translate(-50%, -50%)';
                    helpModal.dataset.initialLoad = 'false'; // Mark as loaded
                }

                // Ensure modal is within viewport if it went off-screen
                const viewportWidth = window.innerWidth;
                const viewportHeight = window.innerHeight;
                let modalRect = helpModal.getBoundingClientRect(); // Get fresh dimensions

                // Adjust position if it's completely off-screen or too far right/bottom
                let currentLeft = parseFloat(helpModal.style.left) || 0;
                let currentTop = parseFloat(helpModal.style.top) || 0;

                // If modal's position is still based on transform, calculate actual left/top
                if (helpModal.style.transform.includes('translate')) {
                    currentLeft = modalRect.left;
                    currentTop = modalRect.top;
                }

                if (currentLeft + modalRect.width > viewportWidth || currentLeft < 0) {
                    helpModal.style.left = `${Math.max(20, viewportWidth - modalRect.width - 20)}px`;
                    helpModal.style.transform = 'none'; // Clear transform if setting explicit left
                }
                if (currentTop + modalRect.height > viewportHeight || currentTop < 0) {
                    helpModal.style.top = `${Math.max(20, viewportHeight - modalRect.height - 20)}px`;
                    helpModal.style.transform = 'none'; // Clear transform if setting explicit top
                }

                // Also constrain initial size if it's larger than viewport
                if (modalRect.width > viewportWidth - 40) {
                    helpModal.style.width = `${viewportWidth - 40}px`;
                }
                if (modalRect.height > viewportHeight - 40) {
                    helpModal.style.height = `${viewportHeight - 40}px`;
                }
            });
        }


        closeHelpModalButton.addEventListener('click', () => {
            helpModal.style.display = 'none';
        });

        // Add resizer handle to the modal
        const resizer = document.createElement('div');
        resizer.classList.add('resizer');
        helpModal.appendChild(resizer);

        // Drag functionality
        helpModalHeader.addEventListener('mousedown', (e) => {
            if (e.target === closeHelpModalButton) return; // Don't drag if clicking close button
            isDraggingHelpModal = true;
            helpModal.style.cursor = 'grabbing';
            helpModal.style.zIndex = ++currentZIndex; // Bring to front on drag start
            
            // Clear transform to use explicit top/left for dragging
            const rect = helpModal.getBoundingClientRect();
            helpModal.style.left = `${rect.left}px`;
            helpModal.style.top = `${rect.top}px`;
            helpModal.style.transform = 'none';

            helpModalOffset = {
                x: e.clientX - rect.left,
                y: e.clientY - rect.top
            };
        });

        // Resize functionality
        resizer.addEventListener('mousedown', (e) => {
            isResizingHelpModal = true;
            helpModal.style.cursor = 'se-resize';
            helpModal.style.zIndex = ++currentZIndex; // Bring to front on resize start
            helpModal.classList.add('resizing'); // Add class to disable native resize

            initialModalWidth = helpModal.offsetWidth;
            initialModalHeight = helpModal.offsetHeight;
            initialMouseX = e.clientX;
            initialMouseY = e.clientY;

            e.preventDefault(); // Prevent text selection during resize
        });

        document.addEventListener('mousemove', (e) => {
            if (isDraggingHelpModal) {
                e.preventDefault();

                let newLeft = e.clientX - helpModalOffset.x;
                let newTop = e.clientY - helpModalOffset.y;

                const viewportWidth = window.innerWidth;
                const viewportHeight = window.innerHeight;
                const minWidth = 300; // from CSS
                const minHeight = 200; // from CSS
                const padding = 20; // from body padding

                // Constrain position within viewport
                newLeft = Math.max(padding, Math.min(newLeft, viewportWidth - helpModal.offsetWidth - padding));
                newTop = Math.max(padding, Math.min(newTop, viewportHeight - helpModal.offsetHeight - padding));

                helpModal.style.left = `${newLeft}px`;
                helpModal.style.top = `${newTop}px`;
            } else if (isResizingHelpModal) {
                e.preventDefault();

                const dx = e.clientX - initialMouseX;
                const dy = e.clientY - initialMouseY;

                let newWidth = initialModalWidth + dx;
                let newHeight = initialModalHeight + dy;

                const viewportWidth = window.innerWidth;
                const viewportHeight = window.innerHeight;
                const minWidth = 300;
                const minHeight = 200;
                const padding = 20;

                // Constrain size within viewport and min/max
                newWidth = Math.max(minWidth, Math.min(newWidth, viewportWidth - (parseFloat(helpModal.style.left) || 0) - padding));
                newHeight = Math.max(minHeight, Math.min(newHeight, viewportHeight - (parseFloat(helpModal.style.top) || 0) - padding));

                helpModal.style.width = `${newWidth}px`;
                helpModal.style.height = `${newHeight}px`;
            }
        });

        document.addEventListener('mouseup', () => {
            isDraggingHelpModal = false;
            isResizingHelpModal = false;
            helpModal.style.cursor = 'default';
            helpModal.classList.remove('resizing'); // Re-enable native resize if needed
        });

        window.addEventListener('resize', () => {
            if (helpModal.style.display === 'block') {
                const viewportWidth = window.innerWidth;
                const viewportHeight = window.innerHeight;
                const padding = 20;

                let modalRect = helpModal.getBoundingClientRect();
                let newLeft = parseFloat(helpModal.style.left) || 0;
                let newTop = parseFloat(helpModal.style.top) || 0;
                let newWidth = parseFloat(helpModal.style.width) || modalRect.width;
                let newHeight = parseFloat(helpModal.style.height) || modalRect.height;
                
                // If modal is still using initial transform, adjust its values first
                if (helpModal.style.transform === 'translate(-50%, -50%)') {
                    newLeft = viewportWidth / 2 - modalRect.width / 2;
                    newTop = viewportHeight / 2 - modalRect.height / 2;
                    helpModal.style.transform = 'none';
                }

                // Constrain position
                newLeft = Math.max(padding, Math.min(newLeft, viewportWidth - newWidth - padding));
                newTop = Math.max(padding, Math.min(newTop, viewportHeight - newHeight - padding));

                // Constrain size
                newWidth = Math.max(helpModal.style.minWidth ? parseFloat(helpModal.style.minWidth) : 300, Math.min(newWidth, viewportWidth - newLeft - padding));
                newHeight = Math.max(helpModal.style.minHeight ? parseFloat(helpModal.style.minHeight) : 200, Math.min(newHeight, viewportHeight - newTop - padding));
                
                helpModal.style.left = `${newLeft}px`;
                helpModal.style.top = `${newTop}px`;
                helpModal.style.width = `${newWidth}px`;
                helpModal.style.height = `${newHeight}px`;
            }
        });

    </script>
</body>
</html>